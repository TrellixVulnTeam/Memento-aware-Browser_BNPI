// Copyright 2018 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

import './mojo_api.js';

import {html, Polymer} from 'chrome://resources/polymer/v3_0/polymer/polymer_bundled.min.js';

/**
 * @implements {discards.mojom.GraphChangeStreamInterface}
 */
class DiscardsGraphChangeStreamImpl {
  /** @param {Window} contentWindow */
  constructor(contentWindow) {
    /** @private {Window} */
    this.contentWindow_ = contentWindow;
  }

  /**
   * @param {string} type
   * @param {Object|number} data
   */
  postMessage_(type, data) {
    this.contentWindow_.postMessage([type, data], '*');
  }

  /** @override */
  frameCreated(frame) {
    this.postMessage_('frameCreated', frame);
  }

  /** @override */
  pageCreated(page) {
    this.postMessage_('pageCreated', page);
  }

  /** @override */
  processCreated(process) {
    this.postMessage_('processCreated', process);
  }

  /** @override */
  workerCreated(worker) {
    this.postMessage_('workerCreated', worker);
  }

  /** @override */
  frameChanged(frame) {
    this.postMessage_('frameChanged', frame);
  }

  /** @override */
  pageChanged(page) {
    this.postMessage_('pageChanged', page);
  }

  /** @override */
  processChanged(process) {
    this.postMessage_('processChanged', process);
  }

  /** @override */
  workerChanged(worker) {
    this.postMessage_('workerChanged', worker);
  }

  /** @override */
  favIconDataAvailable(icon_info) {
    this.postMessage_('favIconDataAvailable', icon_info);
  }

  /** @override */
  nodeDeleted(nodeId) {
    this.postMessage_('nodeDeleted', nodeId);
  }
}

Polymer({
  is: 'graph-tab',

  _template: html`<!--_html_template_start_-->

    <webview id="webView" src="data:text/html;base64,PCEtLQpDb3B5cmlnaHQgMjAxOCBUaGUgQ2hyb21pdW0gQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZQpmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgoKVGhpcyBkb2N1bWVudCBpcyBsb2FkZWQgaW50byBhIDx3ZWJ2aWV3PiBmcm9tIHRoZSBncmFwaF90YWIgZWxlbWVudCBhcyBhIGRhdGE6ClVSTC4gQXMgcmVzdWx0LCB0aGlzIGRvY3VtZW50IG5lZWRzIHRvIGJlIHNlbGYtY29udGFpbmVkLCBoZW5jZSBpbmxpbmUgc2NyaXB0cy4KLS0+CjxodG1sPgogIDxoZWFkPgogICAgPHN0eWxlPgogICAgICBodG1sLAogICAgICBib2R5IHsKICAgICAgICBoZWlnaHQ6IDEwMCU7CiAgICAgIH0KCiAgICAgIGJvZHkgewogICAgICAgIG1hcmdpbjogMDsKICAgICAgfQoKICAgICAgLmxpbmtzIGxpbmUgewogICAgICAgIHN0cm9rZTogIzk5OTsKICAgICAgICBzdHJva2Utb3BhY2l0eTogMC42OwogICAgICAgIHN0cm9rZS13aWR0aDogMTsKICAgICAgfQoKICAgICAgLmRhc2hlZC1saW5rcyBsaW5lIHsKICAgICAgICBtYXJrZXItc3RhcnQ6IHVybCgjYXJyb3dUb1NvdXJjZSk7CiAgICAgICAgc3Ryb2tlOiAjOTk5OwogICAgICAgIHN0cm9rZS1kYXNoYXJyYXk6IDM7CiAgICAgICAgc3Ryb2tlLW9wYWNpdHk6IDAuNjsKICAgICAgICBzdHJva2Utd2lkdGg6IDE7CiAgICAgIH0KCiAgICAgICNhcnJvd1RvU291cmNlIHsKICAgICAgICBmaWxsOiAjOTk5OwogICAgICAgIHN0cm9rZTogIzk5OTsKICAgICAgfQoKICAgICAgLm5vZGVzIGNpcmNsZSB7CiAgICAgICAgc3Ryb2tlOiAjMDAwOwogICAgICAgIHN0cm9rZS13aWR0aDogMS41cHg7CiAgICAgIH0KCiAgICAgIC5ub2RlcyBjaXJjbGUucGlubmVkIHsKICAgICAgICBzdHJva2U6IHJlZDsKICAgICAgfQoKICAgICAgLmRlYWQgaW1hZ2UgewogICAgICAgIGRpc3BsYXk6IG5vbmU7CiAgICAgIH0KCiAgICAgIC5zZXBhcmF0b3IgewogICAgICAgIGZvbnQ6IGl0YWxpYyAxM3B4IHNhbnMtc2VyaWY7CiAgICAgICAgdXNlci1zZWxlY3Q6IG5vbmU7CiAgICAgIH0KCiAgICAgIGRpdi50b29sdGlwIHsKICAgICAgICBiYWNrZ3JvdW5kOiBsaWdodHN0ZWVsYmx1ZTsKICAgICAgICBib3JkZXI6IDA7CiAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgIHBhZGRpbmc6IDJweDsKICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICB9CgogICAgICB0ciB7CiAgICAgICAgZm9udDogMTBweCBzYW5zLXNlcmlmOwogICAgICB9CgogICAgICB0ci5oZWFkaW5nID4gdGQgewogICAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgfQoKICAgICAgdHIudmFsdWUgPiB0ZDpudGgtY2hpbGQoMSkgewogICAgICAgIHRleHQtYWxpZ246IGVuZDsKICAgICAgfQoKICAgIDwvc3R5bGU+CiAgPHNjcmlwdCBzcmM9Imh0dHBzOi8vYWpheC5nb29nbGVhcGlzLmNvbS9hamF4L2xpYnMvZDNqcy81LjcuMC9kMy5taW4uanMiCiAgICAgIGludGVncml0eT0ic2hhMzg0LUhMOTZkdW4xS2JZRXE2VVQvWmxzc3BBT0RDeVErWnA0ejMxOGFqVVBCUFNNenk1ZHZ4bDZ6aXdtbmlsOC9DcGQiCiAgICAgIGNyb3Nzb3JpZ2luPSJhbm9ueW1vdXMiPgogIDwvc2NyaXB0PgogIDxzY3JpcHQgdHlwZT0iYXBwbGljYXRpb24vamF2YXNjcmlwdCI+Ci8vIENvcHlyaWdodCAyMDE4IFRoZSBDaHJvbWl1bSBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgovLyBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlCi8vIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCgovLyBSYWRpdXMgb2YgYSBub2RlIGNpcmNsZS4KY29uc3QgLyoqIG51bWJlciAqLyBrTm9kZVJhZGl1cyA9IDY7CgovLyBUYXJnZXQgeSBwb3NpdGlvbiBmb3IgcGFnZSBub2Rlcy4KY29uc3QgLyoqIG51bWJlciAqLyBrUGFnZU5vZGVzVGFyZ2V0WSA9IDIwOwoKLy8gUmFuZ2Ugb2NjdXBpZWQgYnkgcGFnZSBub2RlcyBhdCB0aGUgdG9wIG9mIHRoZSBncmFwaCB2aWV3Lgpjb25zdCAvKiogbnVtYmVyICovIGtQYWdlTm9kZXNZUmFuZ2UgPSAxMDA7CgovLyBSYW5nZSBvY2N1cGllZCBieSBwcm9jZXNzIG5vZGVzIGF0IHRoZSBib3R0b20gb2YgdGhlIGdyYXBoIHZpZXcuCmNvbnN0IC8qKiBudW1iZXIgKi8ga1Byb2Nlc3NOb2Rlc1lSYW5nZSA9IDEwMDsKCi8vIFJhbmdlIG9jY3VwaWVkIGJ5IHdvcmtlciBub2RlcyBhdCB0aGUgYm90dG9tIG9mIHRoZSBncmFwaCB2aWV3LCBhYm92ZQovLyBwcm9jZXNzIG5vZGVzLgpjb25zdCAvKiogbnVtYmVyICovIGtXb3JrZXJOb2Rlc1lSYW5nZSA9IDIwMDsKCi8vIFRhcmdldCB5IHBvc2l0aW9uIGZvciBmcmFtZSBub2Rlcy4KY29uc3QgLyoqIG51bWJlciAqLyBrRnJhbWVOb2Rlc1RhcmdldFkgPSBrUGFnZU5vZGVzWVJhbmdlICsgNTA7CgovLyBSYW5nZSB0aGF0IGZyYW1lIG5vZGVzIGNhbm5vdCBlbnRlciBhdCB0aGUgdG9wL2JvdHRvbSBvZiB0aGUgZ3JhcGggdmlldy4KY29uc3QgLyoqIG51bWJlciAqLyBrRnJhbWVOb2Rlc1RvcE1hcmdpbiA9IGtQYWdlTm9kZXNZUmFuZ2U7CmNvbnN0IC8qKiBudW1iZXIgKi8ga0ZyYW1lTm9kZXNCb3R0b21NYXJnaW4gPSBrV29ya2VyTm9kZXNZUmFuZ2UgKyA1MDsKCi8vIFRoZSBtYXhpbXVtIHN0cmVuZ3RoIG9mIGEgYm91bmRhcnkgZm9yY2UuCi8vIEFjY29yZGluZyB0byBodHRwczovL2dpdGh1Yi5jb20vZDMvZDMtZm9yY2UjcG9zaXRpb25pbmcsIHN0cmVuZ3RoIHZhbHVlcwovLyBvdXRzaWRlIHRoZSByYW5nZSBbMCwxXSBhcmUgIm5vdCByZWNvbW1lbmRlZCIuCmNvbnN0IC8qKiBudW1iZXIgKi8ga01heEJvdW5kYXJ5U3RyZW5ndGggPSAxOwoKLy8gVGhlIHN0cmVuZ3RoIG9mIGEgaGlnaCBZLWZvcmNlLiBUaGlzIGlzIGFwcHJvcHJpYXRlIGZvciBmb3JjZXMgdGhhdAovLyBzdHJvbmdseSBwdWxsIHRvd2FyZHMgYW4gYXR0cmFjdG9yLCBidXQgY2FuIHN0aWxsIGJlIG92ZXJyaWRkZW4gYnkgdGhlCi8vIHN0cm9uZ2VzdCBmb3JjZS4KY29uc3QgLyoqIG51bWJlciAqLyBrSGlnaFlTdHJlbmd0aCA9IDAuOTsKCi8vIFRoZSBzdHJlbmd0aCBvZiBhIHdlYWsgWS1mb3JjZS4gVGhpcyBpcyBhcHByb3ByaWF0ZSBmb3IgZm9yY2VzIHRoYXQgZXhlcnQKLy8gc29tZSBpbmZsdWVuY2UgYnV0IGNhbiBiZSBlYXNpbHkgb3ZlcnJpZGRlbi4KY29uc3QgLyoqIG51bWJlciAqLyBrV2Vha1lTdHJlbmd0aCA9IDAuMTsKCmNsYXNzIFRvb2xUaXAgewogIC8qKgogICAqIEBwYXJhbSB7RWxlbWVudH0gZGl2CiAgICogQHBhcmFtIHtHcmFwaE5vZGV9IG5vZGUKICAgKi8KICBjb25zdHJ1Y3RvcihkaXYsIG5vZGUpIHsKICAgIC8qKiBAdHlwZSB7Ym9vbGVhbn0gKi8KICAgIHRoaXMuZmxvYXRpbmcgPSB0cnVlOwoKICAgIC8qKiBAdHlwZSB7bnVtYmVyfSAqLwogICAgdGhpcy54ID0gbm9kZS54OwoKICAgIC8qKiBAdHlwZSB7bnVtYmVyfSAqLwogICAgdGhpcy55ID0gbm9kZS55IC0gMjg7CgogICAgLyoqIEB0eXBlIHtHcmFwaE5vZGV9ICovCiAgICB0aGlzLm5vZGUgPSBub2RlOwoKICAgIC8qKiBAcHJpdmF0ZSB7ZDMuc2VsZWN0aW9ufSAqLwogICAgdGhpcy5kaXZfID0gZDMuc2VsZWN0KGRpdikKICAgICAgICAgICAgICAgICAgICAuYXBwZW5kKCdkaXYnKQogICAgICAgICAgICAgICAgICAgIC5hdHRyKCdjbGFzcycsICd0b29sdGlwJykKICAgICAgICAgICAgICAgICAgICAuc3R5bGUoJ29wYWNpdHknLCAwKQogICAgICAgICAgICAgICAgICAgIC5zdHlsZSgnbGVmdCcsIGAke3RoaXMueH1weGApCiAgICAgICAgICAgICAgICAgICAgLnN0eWxlKCd0b3AnLCBgJHt0aGlzLnl9cHhgKTsKICAgIHRoaXMuZGl2Xy5hcHBlbmQoJ3RhYmxlJykuYXBwZW5kKCd0Ym9keScpOwogICAgdGhpcy5kaXZfLnRyYW5zaXRpb24oKS5kdXJhdGlvbigyMDApLnN0eWxlKCdvcGFjaXR5JywgLjkpOwoKICAgIC8qKiBAcHJpdmF0ZSB7c3RyaW5nfSAqLwogICAgdGhpcy5kZXNjcmlwdGlvbl9qc29uXyA9ICcnOwogICAgLy8gU2V0IHVwIGEgZHJhZyBiZWhhdmlvciBmb3IgdGhpcyBvYmplY3QncyBkaXYuCiAgICBjb25zdCBkcmFnID0gZDMuZHJhZygpLnN1YmplY3QoKCkgPT4gdGhpcyk7CiAgICBkcmFnLm9uKCdzdGFydCcsIHRoaXMub25EcmFnU3RhcnRfLmJpbmQodGhpcykpOwogICAgZHJhZy5vbignZHJhZycsIHRoaXMub25EcmFnXy5iaW5kKHRoaXMpKTsKICAgIHRoaXMuZGl2Xy5jYWxsKGRyYWcpOwoKICAgIHRoaXMub25EZXNjcmlwdGlvbihKU09OLnN0cmluZ2lmeSh7fSkpOwogIH0KCiAgbm9kZU1vdmVkKCkgewogICAgaWYgKCF0aGlzLmZsb2F0aW5nKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBjb25zdCBub2RlID0gdGhpcy5ub2RlOwogICAgdGhpcy54ID0gbm9kZS54OwogICAgdGhpcy55ID0gbm9kZS55IC0gMjg7CiAgICB0aGlzLmRpdl8uc3R5bGUoJ2xlZnQnLCBgJHt0aGlzLnh9cHhgKS5zdHlsZSgndG9wJywgYCR7dGhpcy55fXB4YCk7CiAgfQoKICAvKioKICAgKiBAcmV0dXJuIHshQXJyYXk8bnVtYmVyPn0gVGhlIFt4LCB5XSBjZW50ZXIgb2YgdGhlIFRvb2xUaXAncyBkaXYKICAgKiBlbGVtZW50LgogICAqLwogIGdldENlbnRlcigpIHsKICAgIGNvbnN0IHJlY3QgPSB0aGlzLmRpdl8ubm9kZSgpLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgcmV0dXJuIFtyZWN0LnggKyByZWN0LndpZHRoIC8gMiwgcmVjdC55ICsgcmVjdC5oZWlnaHQgLyAyXTsKICB9CgogIGdvQXdheSgpIHsKICAgIHRoaXMuZGl2Xy50cmFuc2l0aW9uKCkuZHVyYXRpb24oMjAwKS5zdHlsZSgnb3BhY2l0eScsIDApLnJlbW92ZSgpOwogIH0KCiAgLyoqCiAgICogVXBkYXRlcyB0aGUgZGVzY3JpcHRpb24gZGlzcGxheWVkLgogICAqIEBwYXJhbSB7c3RyaW5nfSBkZXNjcmlwdGlvbl9qc29uIEEgSlNPTiBzdHJpbmcuCiAgICovCiAgb25EZXNjcmlwdGlvbihkZXNjcmlwdGlvbl9qc29uKSB7CiAgICBpZiAodGhpcy5kZXNjcmlwdGlvbl9qc29uXyA9PT0gZGVzY3JpcHRpb25fanNvbikgewogICAgICByZXR1cm47CiAgICB9CgogICAgLyoqCiAgICAgKiBIZWxwZXIgZm9yIHJlY3Vyc2l2ZWx5IGZsYXR0ZW5pbmcgYW4gT2JqZWN0LgogICAgICoKICAgICAqIEBwYXJhbSB7IVNldH0gdmlzaXRlZCBUaGUgc2V0IG9mIHZpc2l0ZWQgb2JqZWN0cywgZXhjbHVkaW5nCiAgICAgKiAgICAgICAgICB7QGNvZGUgb2JqZWN0fS4KICAgICAqIEBwYXJhbSB7IU9iamVjdDw/LD8+fSBmbGF0dGVuZWQgVGhlIGZsYXR0ZW5lZCBvYmplY3QgYmVpbmcgYnVpbHQuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCBUaGUgY3VycmVudCBmbGF0dGVuZWQgcGF0aC4KICAgICAqIEBwYXJhbSB7IU9iamVjdDw/LD8+fSBvYmplY3QgVGhlIG5lc3RlZCBkaWN0IHRvIGJlIGZsYXR0ZW5lZC4KICAgICAqLwogICAgZnVuY3Rpb24gZmxhdHRlbk9iamVjdFJlYyh2aXNpdGVkLCBmbGF0dGVuZWQsIHBhdGgsIG9iamVjdCkgewogICAgICBpZiAodHlwZW9mIG9iamVjdCAhPT0gJ29iamVjdCcgfHwgdmlzaXRlZC5oYXMob2JqZWN0KSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2aXNpdGVkLmFkZChvYmplY3QpOwogICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhvYmplY3QpKSB7CiAgICAgICAgY29uc3QgZnVsbFBhdGggPSBwYXRoID8gYCR7cGF0aH0uJHtrZXl9YCA6IGtleTsKICAgICAgICAvLyBSZWN1cnNlIG9uIG5vbi1udWxsIG9iamVjdHMuCiAgICAgICAgaWYgKCEhdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JykgewogICAgICAgICAgZmxhdHRlbk9iamVjdFJlYygKICAgICAgICAgICAgICB2aXNpdGVkLCBmbGF0dGVuZWQsIGZ1bGxQYXRoLAogICAgICAgICAgICAgIC8qKiBAdHlwZSB7IU9iamVjdDw/LD8+fSAqLyAodmFsdWUpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gRXZlcnl0aGluZyBlbHNlIGlzIGNvbnNpZGVyZWQgYSBsZWFmIHZhbHVlLgogICAgICAgICAgZmxhdHRlbmVkW2Z1bGxQYXRoXSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmVjdXJzaXZlbHkgZmxhdHRlbnMgYW4gT2JqZWN0IG9mIGtleS92YWx1ZSBwYWlycy4gTmVzdGVkIG9iamVjdHMgd2lsbCBiZQogICAgICogZmxhdHRlbmVkIHRvIHBhdGhzIHdpdGggYSAuIHNlcGFyYXRvciBiZXR3ZWVuIGVhY2gga2V5LiBJZiB0aGVyZSBhcmUKICAgICAqIGNpcmN1bGFyIGRlcGVuZGVuY2llcywgdGhleSB3aWxsIG5vdCBiZSBleHBhbmRlZC4KICAgICAqCiAgICAgKiBGb3IgZXhhbXBsZSwgY29udmVydGluZzoKICAgICAqCiAgICAgKiB7CiAgICAgKiAgICdmb28nOiAnaGVsbG8nLAogICAgICogICAnYmFyJzogMSwKICAgICAqICAgJ2Jheic6IHsKICAgICAqICAgICAneCc6IDQzLjUsCiAgICAgKiAgICAgJ3knOiAnZm94JwogICAgICogICAgICd6JzogWzEsIDJdCiAgICAgKiAgIH0sCiAgICAgKiAgICdzZWxmJzogKHJlZmVyZW5jZSB0byBzZWxmKQogICAgICogfQogICAgICoKICAgICAqIHdpbGwgeWllbGQ6CiAgICAgKgogICAgICogewogICAgICogICAnZm9vJzogJ2hlbGxvJywKICAgICAqICAgJ2Jhcic6IDEsCiAgICAgKiAgICdiYXoueCc6IDQzLjUsCiAgICAgKiAgICdiYXoueSc6ICdmb3gnLAogICAgICogICAnYmF6LnouMCc6ICcxJywKICAgICAqICAgJ2Jhei55LjEnOiAnMicKICAgICAqIH0KICAgICAqIEBwYXJhbSB7IU9iamVjdDw/LD8+fSBvYmplY3QgVGhlIG9iamVjdCB0byBiZSBmbGF0dGVuZWQuCiAgICAgKiBAcmV0dXJuIHshT2JqZWN0PD8sPz59IHRoZSBmbGF0dGVuZWQgb2JqZWN0LgogICAgICovCiAgICBmdW5jdGlvbiBmbGF0dGVuT2JqZWN0KG9iamVjdCkgewogICAgICBjb25zdCBmbGF0dGVuZWQgPSB7fTsKICAgICAgZmxhdHRlbk9iamVjdFJlYyhuZXcgU2V0KCksIGZsYXR0ZW5lZCwgJycsIG9iamVjdCk7CiAgICAgIHJldHVybiBmbGF0dGVuZWQ7CiAgICB9CgogICAgLy8gVGhlIEpTT04gaXMgYSBkaWN0aW9uYXJ5IG9mIGRhdGEgZGVzY3JpYmVyIG5hbWUgdG8gdGhlaXIgZGF0YS4gQXNzdW1pbmcgYQogICAgLy8gY29udmVudGlvbiB0aGF0IGRlc2NyaWJlcnMgZW1pdCBhIGRpY3Rpb25hcnkgZnJvbSBzdHJpbmctPnN0cmluZywgdGhpcyBpcwogICAgLy8gZmxhdHRlbmVkIHRvIGFuIGFycmF5LiBFYWNoIHRvcC1sZXZlbCBkaWN0aW9uYXJ5IGVudHJ5IGlzIGZsYXR0ZW5lZCB0byBhCiAgICAvLyAnaGVhZGluZycgd2l0aCBbYHRoZSBkZXNjcmliZXIncyBuYW1lYCwgbnVsbF0sIGZvbGxvd2VkIGJ5IHNvbWUgbnVtYmVyIG9mCiAgICAvLyBlbnRyaWVzIHdpdGggYSB0d28tZWxlbWVudCBsaXN0LCBlYWNoIHJlcHJlc2VudGluZyBhIGtleS92YWx1ZSBwYWlyLgogICAgdGhpcy5kZXNjcmlwdGlvbl9qc29uXyA9IGRlc2NyaXB0aW9uX2pzb247CiAgICBjb25zdCBkZXNjcmlwdGlvbiA9CiAgICAgICAgLyoqIEB0eXBlIHshT2JqZWN0PD8sPz59ICovIChKU09OLnBhcnNlKGRlc2NyaXB0aW9uX2pzb24pKTsKICAgIGNvbnN0IGZsYXR0ZW5lZERlc2NyaXB0aW9uID0gW107CiAgICBmb3IgKGNvbnN0IFt0aXRsZSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGRlc2NyaXB0aW9uKSkgewogICAgICBmbGF0dGVuZWREZXNjcmlwdGlvbi5wdXNoKFt0aXRsZSwgbnVsbF0pOwogICAgICBjb25zdCBmbGF0dGVuZWRWYWx1ZSA9IGZsYXR0ZW5PYmplY3QodmFsdWUpOwogICAgICBmb3IgKGNvbnN0IFtwcm9wTmFtZSwgcHJvcFZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhmbGF0dGVuZWRWYWx1ZSkpIHsKICAgICAgICBsZXQgc3RyVmFsdWUgPSBTdHJpbmcocHJvcFZhbHVlKTsKICAgICAgICBpZiAoc3RyVmFsdWUubGVuZ3RoID4gNTApIHsKICAgICAgICAgIHN0clZhbHVlID0gYCR7c3RyVmFsdWUuc3Vic3RyaW5nKDAsIDQ3KX0uLi5gOwogICAgICAgIH0KICAgICAgICBmbGF0dGVuZWREZXNjcmlwdGlvbi5wdXNoKFtwcm9wTmFtZSwgc3RyVmFsdWVdKTsKICAgICAgfQogICAgfQogICAgaWYgKGZsYXR0ZW5lZERlc2NyaXB0aW9uLmxlbmd0aCA9PT0gMCkgewogICAgICBmbGF0dGVuZWREZXNjcmlwdGlvbi5wdXNoKFsnTm8gRGF0YScsIG51bGxdKTsKICAgIH0KCiAgICBsZXQgdHIgPQogICAgICAgIHRoaXMuZGl2Xy5zZWxlY3RBbGwoJ3Rib2R5Jykuc2VsZWN0QWxsKCd0cicpLmRhdGEoZmxhdHRlbmVkRGVzY3JpcHRpb24pOwogICAgdHIuZW50ZXIoKS5hcHBlbmQoJ3RyJykuc2VsZWN0QWxsKCd0ZCcpLmRhdGEoZCA9PiBkKS5lbnRlcigpLmFwcGVuZCgndGQnKTsKICAgIHRyLmV4aXQoKS5yZW1vdmUoKTsKCiAgICB0ciA9IHRoaXMuZGl2Xy5zZWxlY3RBbGwoJ3RyJyk7CiAgICB0ci5zZWxlY3QoJ3RkJykuYXR0cignY29sc3BhbicsIGZ1bmN0aW9uKGQpIHsKICAgICAgcmV0dXJuIChkMy5zZWxlY3QodGhpcy5wYXJlbnRFbGVtZW50KS5kYXR1bSgpWzFdID09PSBudWxsKSA/IDIgOiBudWxsOwogICAgfSk7CiAgICB0ciA9IHRyLmF0dHIoJ2NsYXNzJywgZCA9PiBkWzFdID09PSBudWxsID8gJ2hlYWRpbmcnIDogJ3ZhbHVlJyk7CiAgICB0ci5zZWxlY3RBbGwoJ3RkJykuZGF0YShkID0+IGQpLnRleHQoZCA9PiBkID09PSBudWxsID8gJycgOiBkKTsKICB9CgogIC8qKiBAcHJpdmF0ZSAqLwogIG9uRHJhZ1N0YXJ0XygpIHsKICAgIHRoaXMuZmxvYXRpbmcgPSBmYWxzZTsKICB9CgogIC8qKiBAcHJpdmF0ZSAqLwogIG9uRHJhZ18oKSB7CiAgICB0aGlzLnggPSBkMy5ldmVudC54OwogICAgdGhpcy55ID0gZDMuZXZlbnQueTsKICAgIHRoaXMuZGl2Xy5zdHlsZSgnbGVmdCcsIGAke3RoaXMueH1weGApLnN0eWxlKCd0b3AnLCBgJHt0aGlzLnl9cHhgKTsKCiAgICBncmFwaC51cGRhdGVUb29sVGlwTGlua3MoKTsKICB9Cn0KCi8qKiBAaW1wbGVtZW50cyB7ZDMuRm9yY2VOb2RlfSAqLwpjbGFzcyBHcmFwaE5vZGUgewogIGNvbnN0cnVjdG9yKGlkKSB7CiAgICAvKiogQHR5cGUge251bWJlcn0gKi8KICAgIHRoaXMuaWQgPSBpZDsKICAgIC8qKiBAdHlwZSB7c3RyaW5nfSAqLwogICAgdGhpcy5jb2xvciA9ICdibGFjayc7CiAgICAvKiogQHR5cGUge3N0cmluZ30gKi8KICAgIHRoaXMuaWNvblVybCA9ICcnOwoKICAgIC8qKiBAdHlwZSB7VG9vbFRpcH0gKi8KICAgIHRoaXMudG9vbHRpcCA9IG51bGw7CgogICAgLyoqCiAgICAgKiBJbXBsZW1lbnRhdGlvbiBvZiB0aGUgZDMuRm9yY2VOb2RlIGludGVyZmFjZS4KICAgICAqIFNlZSBodHRwczovL2dpdGh1Yi5jb20vZDMvZDMtZm9yY2Ujc2ltdWxhdGlvbl9ub2Rlcy4KICAgICAqIEB0eXBlIHtudW1iZXJ8dW5kZWZpbmVkfQogICAgICovCiAgICB0aGlzLmluZGV4OwogICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovCiAgICB0aGlzLng7CiAgICAvKiogQHR5cGUge251bWJlcn0gKi8KICAgIHRoaXMueTsKICAgIC8qKiBAdHlwZSB7bnVtYmVyfHVuZGVmaW5lZH0gKi8KICAgIHRoaXMudng7CiAgICAvKiogQHR5cGUge251bWJlcnx1bmRlZmluZWR9ICovCiAgICB0aGlzLnZ5OwogICAgdGhpcy5meCA9IG51bGw7CiAgICB0aGlzLmZ5ID0gbnVsbDsKICB9CgogIC8qKiBAcmV0dXJuIHtzdHJpbmd9ICovCiAgZ2V0IHRpdGxlKCkgewogICAgcmV0dXJuICcnOwogIH0KCiAgLyoqCiAgICogU2V0cyB0aGUgaW5pdGlhbCB4IGFuZCB5IHBvc2l0aW9uIG9mIHRoaXMgbm9kZSwgYWxzbyByZXNldHMKICAgKiB2eCBhbmQgdnkuCiAgICogQHBhcmFtIHtudW1iZXJ9IGdyYXBoV2lkdGggV2lkdGggb2YgdGhlIGdyYXBoIHZpZXcgKHN2ZykuCiAgICogQHBhcmFtIHtudW1iZXJ9IGdyYXBoSGVpZ2h0IEhlaWdodCBvZiB0aGUgZ3JhcGggdmlldyAoc3ZnKS4KICAgKi8KICBzZXRJbml0aWFsUG9zaXRpb24oZ3JhcGhXaWR0aCwgZ3JhcGhIZWlnaHQpIHsKICAgIHRoaXMueCA9IGdyYXBoV2lkdGggLyAyOwogICAgdGhpcy55ID0gdGhpcy50YXJnZXRZUG9zaXRpb24oZ3JhcGhIZWlnaHQpOwogICAgdGhpcy52eCA9IDA7CiAgICB0aGlzLnZ5ID0gMDsKICB9CgogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBncmFwaEhlaWdodCBIZWlnaHQgb2YgdGhlIGdyYXBoIHZpZXcgKHN2ZykuCiAgICogQHJldHVybiB7bnVtYmVyfQogICAqLwogIHRhcmdldFlQb3NpdGlvbihncmFwaEhlaWdodCkgewogICAgY29uc3QgYm91bmRzID0gdGhpcy5hbGxvd2VkWVJhbmdlKGdyYXBoSGVpZ2h0KTsKICAgIHJldHVybiAoYm91bmRzWzBdICsgYm91bmRzWzFdKSAvIDI7CiAgfQoKICAvKioKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBzdHJlbmd0aCBvZiB0aGUgZm9yY2UgdGhhdCBwdWxscyB0aGUgbm9kZSB0b3dhcmRzCiAgICogICAgIGl0cyB0YXJnZXQgeSBwb3NpdGlvbi4KICAgKi8KICBnZXQgdGFyZ2V0WVBvc2l0aW9uU3RyZW5ndGgoKSB7CiAgICByZXR1cm4ga1dlYWtZU3RyZW5ndGg7CiAgfQoKICAvKioKICAgKiBAcmV0dXJuIHtudW1iZXJ9IEEgc2NhbGluZyBmYWN0b3IgYXBwbGllZCB0byB0aGUgc3RyZW5ndGggb2YgbGlua3MgdG8gdGhpcwogICAqICAgICBub2RlLgogICAqLwogIGdldCBsaW5rU3RyZW5ndGhTY2FsaW5nRmFjdG9yKCkgewogICAgcmV0dXJuIDE7CiAgfQoKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gZ3JhcGhIZWlnaHQgSGVpZ2h0IG9mIHRoZSBncmFwaCB2aWV3LgogICAqIEByZXR1cm4geyFBcnJheTxudW1iZXI+fQogICAqLwogIGFsbG93ZWRZUmFuZ2UoZ3JhcGhIZWlnaHQpIHsKICAgIC8vIEJ5IGRlZmF1bHQsIG5vZGVzIGp1c3QgbmVlZCB0byBiZSBpbiBib3VuZHMgb2YgdGhlIGdyYXBoLgogICAgcmV0dXJuIFswLCBncmFwaEhlaWdodF07CiAgfQoKICAvKiogQHJldHVybiB7bnVtYmVyfSBUaGUgc3RyZW5ndGggb2YgdGhlIHJlcHVsc2lvbiBmb3JjZSB3aXRoIG90aGVyIG5vZGVzLiAqLwogIGdldCBtYW55Qm9keVN0cmVuZ3RoKCkgewogICAgcmV0dXJuIC0yMDA7CiAgfQoKICAvKiogQHJldHVybiB7IUFycmF5PG51bWJlcj59IGFuIGFycmF5IG9mIG5vZGUgaWRzLiAqLwogIGdldCBsaW5rVGFyZ2V0cygpIHsKICAgIHJldHVybiBbXTsKICB9CgogIC8qKgogICAqIERhc2hlZCBsaW5rcyBleHByZXNzIG93bmVyc2hpcCByZWxhdGlvbnNoaXBzLiBBbiBvYmplY3QgY2FuIG93biBtdWx0aXBsZQogICAqIHRoaW5ncywgYnV0IGJlIG93bmVkIGJ5IGV4YWN0bHkgb25lIChwZXIgcmVsYXRpb25zaGlwIHR5cGUpLiBBcyBzdWNoLCB0aGUKICAgKiByZWxhdGlvbnNoaXAgaXMgZXhwcmVzc2VkIG9uIHRoZSAqb3duZWQqIG9iamVjdC4gVGhlc2UgbGlua3MgYXJlIGRyYXduIHdpdGgKICAgKiBhbiBhcnJvdyBhdCB0aGUgYmVnaW5uaW5nIG9mIHRoZSBsaW5rLCBwb2ludGluZyB0byB0aGUgb3duZWQgb2JqZWN0LgogICAqIEByZXR1cm4geyFBcnJheTxudW1iZXI+fSBhbiBhcnJheSBvZiBub2RlIGlkcy4KICAgKi8KICBnZXQgZGFzaGVkTGlua1RhcmdldHMoKSB7CiAgICByZXR1cm4gW107CiAgfQoKICAvKioKICAgKiBTZWxlY3RzIGEgY29sb3Igc3RyaW5nIGZyb20gYW4gaWQuCiAgICogQHBhcmFtIHtudW1iZXJ9IGlkIFRoZSBpZCB0aGUgcmV0dXJuZWQgY29sb3IgaXMgc2VsZWN0ZWQgZnJvbS4KICAgKiBAcmV0dXJuIHtzdHJpbmd9CiAgICovCiAgc2VsZWN0Q29sb3IoaWQpIHsKICAgIHJldHVybiBkMy5zY2hlbWVTZXQzW01hdGguYWJzKGlkKSAlIDEyXTsKICB9Cn0KCmNsYXNzIFBhZ2VOb2RlIGV4dGVuZHMgR3JhcGhOb2RlIHsKICAvKiogQHBhcmFtIHshZGlzY2FyZHMubW9qb20uUGFnZUluZm99IHBhZ2UgKi8KICBjb25zdHJ1Y3RvcihwYWdlKSB7CiAgICBzdXBlcihwYWdlLmlkKTsKICAgIC8qKiBAdHlwZSB7IWRpc2NhcmRzLm1vam9tLlBhZ2VJbmZvfSAqLwogICAgdGhpcy5wYWdlID0gcGFnZTsKICAgIHRoaXMueSA9IGtQYWdlTm9kZXNUYXJnZXRZOwogIH0KCiAgLyoqIG92ZXJyaWRlICovCiAgZ2V0IHRpdGxlKCkgewogICAgcmV0dXJuIHRoaXMucGFnZS5tYWluRnJhbWVVcmwudXJsLmxlbmd0aCA+IDAgPyB0aGlzLnBhZ2UubWFpbkZyYW1lVXJsLnVybCA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdQYWdlJzsKICB9CgogIC8qKiBAb3ZlcnJpZGUgKi8KICBnZXQgdGFyZ2V0WVBvc2l0aW9uU3RyZW5ndGgoKSB7CiAgICAvLyBHcmF2aXRhdGUgc3Ryb25nbHkgdG93YXJkcyB0aGUgdG9wIG9mIHRoZSBncmFwaC4gQ2FuIGJlIG92ZXJyaWRkZW4gYnkKICAgIC8vIHRoZSBib3VuZGluZyBmb3JjZSB3aGljaCB1c2VzIGtNYXhCb3VuZGFyeVN0cmVuZ3RoLgogICAgcmV0dXJuIGtIaWdoWVN0cmVuZ3RoOwogIH0KCiAgLyoqIEBvdmVycmlkZSAqLwogIGdldCBsaW5rU3RyZW5ndGhTY2FsaW5nRmFjdG9yKCkgewogICAgLy8gR2l2ZSBsaW5rcyBmcm9tIGZyYW1lIG5vZGVzIHRvIHBhZ2Ugbm9kZXMgbGVzcyB3ZWlnaHQgdGhhbiBsaW5rcyBiZXR3ZWVuCiAgICAvLyBmcmFtZSBub2Rlcywgc28gdGhlIHRoYXQgWSBmb3JjZXMgcHVsbGluZyBwYWdlIG5vZGVzIGludG8gdGhlaXIgYXJlYSBjYW4KICAgIC8vIGRvbWluYXRlIG92ZXIgbGluayBmb3JjZXMgcHVsbGluZyB0aGVtIHRvd2FyZHMgZnJhbWUgbm9kZXMuCiAgICByZXR1cm4gMC41OwogIH0KCiAgLyoqIG92ZXJyaWRlICovCiAgYWxsb3dlZFlSYW5nZShncmFwaEhlaWdodCkgewogICAgcmV0dXJuIFswLCBrUGFnZU5vZGVzWVJhbmdlXTsKICB9CgogIC8qKiBvdmVycmlkZSAqLwogIGdldCBtYW55Qm9keVN0cmVuZ3RoKCkgewogICAgcmV0dXJuIC02MDA7CiAgfQoKICAvKiogb3ZlcnJpZGUgKi8KICBnZXQgZGFzaGVkTGlua1RhcmdldHMoKSB7CiAgICBpZiAodGhpcy5wYWdlLm9wZW5lckZyYW1lSWQpIHsKICAgICAgcmV0dXJuIFt0aGlzLnBhZ2Uub3BlbmVyRnJhbWVJZF07CiAgICB9CiAgICByZXR1cm4gW107CiAgfQp9CgpjbGFzcyBGcmFtZU5vZGUgZXh0ZW5kcyBHcmFwaE5vZGUgewogIC8qKiBAcGFyYW0geyFkaXNjYXJkcy5tb2pvbS5GcmFtZUluZm99IGZyYW1lICovCiAgY29uc3RydWN0b3IoZnJhbWUpIHsKICAgIHN1cGVyKGZyYW1lLmlkKTsKICAgIC8qKiBAdHlwZSB7IWRpc2NhcmRzLm1vam9tLkZyYW1lSW5mb30gZnJhbWUgKi8KICAgIHRoaXMuZnJhbWUgPSBmcmFtZTsKICAgIHRoaXMuY29sb3IgPSB0aGlzLnNlbGVjdENvbG9yKGZyYW1lLnByb2Nlc3NJZCk7CiAgfQoKICAvKiogb3ZlcnJpZGUgKi8KICBnZXQgdGl0bGUoKSB7CiAgICByZXR1cm4gdGhpcy5mcmFtZS51cmwudXJsLmxlbmd0aCA+IDAgPyB0aGlzLmZyYW1lLnVybC51cmwgOiAnRnJhbWUnOwogIH0KCiAgLyoqIG92ZXJyaWRlICovCiAgdGFyZ2V0WVBvc2l0aW9uKGdyYXBoSGVpZ2h0KSB7CiAgICByZXR1cm4ga0ZyYW1lTm9kZXNUYXJnZXRZOwogIH0KCiAgLyoqIG92ZXJyaWRlICovCiAgYWxsb3dlZFlSYW5nZShncmFwaEhlaWdodCkgewogICAgcmV0dXJuIFtrRnJhbWVOb2Rlc1RvcE1hcmdpbiwgZ3JhcGhIZWlnaHQgLSBrRnJhbWVOb2Rlc0JvdHRvbU1hcmdpbl07CiAgfQoKICAvKiogb3ZlcnJpZGUgKi8KICBnZXQgbGlua1RhcmdldHMoKSB7CiAgICAvLyBPbmx5IGxpbmsgdG8gdGhlIHBhZ2UgaWYgdGhlcmUgaXNuJ3QgYSBwYXJlbnQgZnJhbWUuCiAgICByZXR1cm4gWwogICAgICB0aGlzLmZyYW1lLnBhcmVudEZyYW1lSWQgfHwgdGhpcy5mcmFtZS5wYWdlSWQsIHRoaXMuZnJhbWUucHJvY2Vzc0lkCiAgICBdOwogIH0KfQoKY2xhc3MgUHJvY2Vzc05vZGUgZXh0ZW5kcyBHcmFwaE5vZGUgewogIC8qKiBAcGFyYW0geyFkaXNjYXJkcy5tb2pvbS5Qcm9jZXNzSW5mb30gcHJvY2VzcyAqLwogIGNvbnN0cnVjdG9yKHByb2Nlc3MpIHsKICAgIHN1cGVyKHByb2Nlc3MuaWQpOwogICAgLyoqIEB0eXBlIHshZGlzY2FyZHMubW9qb20uUHJvY2Vzc0luZm99ICovCiAgICB0aGlzLnByb2Nlc3MgPSBwcm9jZXNzOwoKICAgIHRoaXMuY29sb3IgPSB0aGlzLnNlbGVjdENvbG9yKHByb2Nlc3MuaWQpOwogIH0KCiAgLyoqIG92ZXJyaWRlICovCiAgZ2V0IHRpdGxlKCkgewogICAgcmV0dXJuIGBQSUQ6ICR7dGhpcy5wcm9jZXNzLnBpZC5waWR9YDsKICB9CgogIC8qKiBAcmV0dXJuIHtudW1iZXJ9ICovCiAgZ2V0IHRhcmdldFlQb3NpdGlvblN0cmVuZ3RoKCkgewogICAgLy8gR3Jhdml0YXRlIHN0cm9uZ2x5IHRvd2FyZHMgdGhlIGJvdHRvbSBvZiB0aGUgZ3JhcGguIENhbiBiZSBvdmVycmlkZGVuIGJ5CiAgICAvLyB0aGUgYm91bmRpbmcgZm9yY2Ugd2hpY2ggdXNlcyBrTWF4Qm91bmRhcnlTdHJlbmd0aC4KICAgIHJldHVybiBrSGlnaFlTdHJlbmd0aDsKICB9CgogIC8qKiBAb3ZlcnJpZGUgKi8KICBnZXQgbGlua1N0cmVuZ3RoU2NhbGluZ0ZhY3RvcigpIHsKICAgIC8vIEdpdmUgbGlua3MgdG8gcHJvY2VzcyBub2RlcyBsZXNzIHdlaWdodCB0aGFuIGxpbmtzIGJldHdlZW4gZnJhbWUgbm9kZXMsCiAgICAvLyBzbyB0aGUgdGhhdCBZIGZvcmNlcyBwdWxsaW5nIHByb2Nlc3Mgbm9kZXMgaW50byB0aGVpciBhcmVhIGNhbiBkb21pbmF0ZQogICAgLy8gb3ZlciBsaW5rIGZvcmNlcyBwdWxsaW5nIHRoZW0gdG93YXJkcyBmcmFtZSBub2Rlcy4KICAgIHJldHVybiAwLjU7CiAgfQoKICAvKiogb3ZlcnJpZGUgKi8KICBhbGxvd2VkWVJhbmdlKGdyYXBoSGVpZ2h0KSB7CiAgICByZXR1cm4gW2dyYXBoSGVpZ2h0IC0ga1Byb2Nlc3NOb2Rlc1lSYW5nZSwgZ3JhcGhIZWlnaHRdOwogIH0KCiAgLyoqIG92ZXJyaWRlICovCiAgZ2V0IG1hbnlCb2R5U3RyZW5ndGgoKSB7CiAgICByZXR1cm4gLTYwMDsKICB9Cn0KCmNsYXNzIFdvcmtlck5vZGUgZXh0ZW5kcyBHcmFwaE5vZGUgewogIC8qKiBAcGFyYW0geyFkaXNjYXJkcy5tb2pvbS5Xb3JrZXJJbmZvfSB3b3JrZXIgKi8KICBjb25zdHJ1Y3Rvcih3b3JrZXIpIHsKICAgIHN1cGVyKHdvcmtlci5pZCk7CiAgICAvKiogQHR5cGUgeyFkaXNjYXJkcy5tb2pvbS5Xb3JrZXJJbmZvfSAqLwogICAgdGhpcy53b3JrZXIgPSB3b3JrZXI7CgogICAgdGhpcy5jb2xvciA9IHRoaXMuc2VsZWN0Q29sb3Iod29ya2VyLnByb2Nlc3NJZCk7CiAgfQoKICAvKiogb3ZlcnJpZGUgKi8KICBnZXQgdGl0bGUoKSB7CiAgICByZXR1cm4gdGhpcy53b3JrZXIudXJsLnVybC5sZW5ndGggPiAwID8gdGhpcy53b3JrZXIudXJsLnVybCA6ICdXb3JrZXInOwogIH0KCiAgLyoqIEByZXR1cm4ge251bWJlcn0gKi8KICBnZXQgdGFyZ2V0WVBvc2l0aW9uU3RyZW5ndGgoKSB7CiAgICAvLyBHcmF2aXRhdGUgc3Ryb25nbHkgdG93YXJkcyB0aGUgd29ya2VyIGFyZWEgb2YgdGhlIGdyYXBoLiBDYW4gYmUKICAgIC8vIG92ZXJyaWRkZW4gYnkgdGhlIGJvdW5kaW5nIGZvcmNlIHdoaWNoIHVzZXMga01heEJvdW5kYXJ5U3RyZW5ndGguCiAgICByZXR1cm4ga0hpZ2hZU3RyZW5ndGg7CiAgfQoKICAvKiogb3ZlcnJpZGUgKi8KICBhbGxvd2VkWVJhbmdlKGdyYXBoSGVpZ2h0KSB7CiAgICByZXR1cm4gWwogICAgICBncmFwaEhlaWdodCAtIGtXb3JrZXJOb2Rlc1lSYW5nZSwgZ3JhcGhIZWlnaHQgLSBrUHJvY2Vzc05vZGVzWVJhbmdlCiAgICBdOwogIH0KCiAgLyoqIG92ZXJyaWRlICovCiAgZ2V0IG1hbnlCb2R5U3RyZW5ndGgoKSB7CiAgICByZXR1cm4gLTYwMDsKICB9CgogIC8qKiBvdmVycmlkZSAqLwogIGdldCBsaW5rVGFyZ2V0cygpIHsKICAgIC8vIExpbmsgdGhlIHByb2Nlc3MsIGluIGFkZGl0aW9uIHRvIGFsbCB0aGUgY2xpZW50IGFuZCBjaGlsZCB3b3JrZXJzLgogICAgcmV0dXJuIFsKICAgICAgdGhpcy53b3JrZXIucHJvY2Vzc0lkLCAuLi50aGlzLndvcmtlci5jbGllbnRGcmFtZUlkcywKICAgICAgLi4udGhpcy53b3JrZXIuY2xpZW50V29ya2VySWRzLCAuLi50aGlzLndvcmtlci5jaGlsZFdvcmtlcklkcwogICAgXTsKICB9Cn0KCi8qKgogKiBBIGZvcmNlIHRoYXQgYm91bmRzIEdyYXBoTm9kZXMgfGFsbG93ZWRZUmFuZ2V8IGluIFksCiAqIGFzIHdlbGwgYXMgYm91bmRpbmcgdGhlbSB0byBzdGF5IGluIHBhZ2UgYm91bmRzIGluIFguCiAqIEBwYXJhbSB7bnVtYmVyfSBncmFwaEhlaWdodAogKiBAcGFyYW0ge251bWJlcn0gZ3JhcGhXaWR0aAogKi8KZnVuY3Rpb24gYm91bmRpbmdGb3JjZShncmFwaEhlaWdodCwgZ3JhcGhXaWR0aCkgewogIC8qKiBAdHlwZSB7IUFycmF5PCFHcmFwaE5vZGU+fSAqLwogIGxldCBub2RlcyA9IFtdOwogIC8qKiBAdHlwZSB7IUFycmF5PCFBcnJheT59ICovCiAgbGV0IGJvdW5kcyA9IFtdOwogIGNvbnN0IHhCb3VuZHMgPSBbMiAqIGtOb2RlUmFkaXVzLCBncmFwaFdpZHRoIC0gMiAqIGtOb2RlUmFkaXVzXTsKICBjb25zdCBib3VuZFBvc2l0aW9uID0gKHBvcywgYm91bmQpID0+CiAgICAgIE1hdGgubWF4KGJvdW5kWzBdLCBNYXRoLm1pbihwb3MsIGJvdW5kWzFdKSk7CgogIC8qKiBAcGFyYW0ge251bWJlcn0gYWxwaGEgKi8KICBmdW5jdGlvbiBmb3JjZShhbHBoYSkgewogICAgY29uc3QgbiA9IG5vZGVzLmxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgIGNvbnN0IGJvdW5kID0gYm91bmRzW2ldOwogICAgICBjb25zdCBub2RlID0gbm9kZXNbaV07CgogICAgICAvLyBDYWxjdWxhdGUgd2hlcmUgdGhlIG5vZGUgd2lsbCBlbmQgdXAgYWZ0ZXIgbW92ZW1lbnQuIElmIGl0IHdpbGwgYmUgb3V0CiAgICAgIC8vIG9mIGJvdW5kcyBhcHBseSBhIGNvdW50ZXItZm9yY2UgdG8gYnJpbmcgaXQgYmFjayBpbi4KICAgICAgY29uc3QgeU5leHRQb3NpdGlvbiA9IG5vZGUueSArIG5vZGUudnk7CiAgICAgIGNvbnN0IHlCb3VuZGVkUG9zaXRpb24gPSBib3VuZFBvc2l0aW9uKHlOZXh0UG9zaXRpb24sIGJvdW5kKTsKICAgICAgaWYgKHlOZXh0UG9zaXRpb24gIT09IHlCb3VuZGVkUG9zaXRpb24pIHsKICAgICAgICAvLyBEbyBub3QgaW5jbHVkZSBhbHBoYSBiZWNhdXNlIHdlIHdhbnQgdG8gYmUgc3Ryb25nbHkgcmVwZWxsZWQgZnJvbQogICAgICAgIC8vIHRoZSBib3VuZGFyeSBldmVuIGlmIGFscGhhIGhhcyBkZWNheWVkLgogICAgICAgIG5vZGUudnkgKz0gKHlCb3VuZGVkUG9zaXRpb24gLSB5TmV4dFBvc2l0aW9uKSAqIGtNYXhCb3VuZGFyeVN0cmVuZ3RoOwogICAgICB9CgogICAgICBjb25zdCB4TmV4dFBvc2l0aW9uID0gbm9kZS54ICsgbm9kZS52eDsKICAgICAgY29uc3QgeEJvdW5kZWRQb3NpdGlvbiA9IGJvdW5kUG9zaXRpb24oeE5leHRQb3NpdGlvbiwgeEJvdW5kcyk7CiAgICAgIGlmICh4TmV4dFBvc2l0aW9uICE9PSB4Qm91bmRlZFBvc2l0aW9uKSB7CiAgICAgICAgLy8gRG8gbm90IGluY2x1ZGUgYWxwaGEgYmVjYXVzZSB3ZSB3YW50IHRvIGJlIHN0cm9uZ2x5IHJlcGVsbGVkIGZyb20KICAgICAgICAvLyB0aGUgYm91bmRhcnkgZXZlbiBpZiBhbHBoYSBoYXMgZGVjYXllZC4KICAgICAgICBub2RlLnZ4ICs9ICh4Qm91bmRlZFBvc2l0aW9uIC0geE5leHRQb3NpdGlvbikgKiBrTWF4Qm91bmRhcnlTdHJlbmd0aDsKICAgICAgfQogICAgfQogIH0KCiAgLyoqIEBwYXJhbSB7IUFycmF5PCFHcmFwaE5vZGU+fSBuICovCiAgZm9yY2UuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKG4pIHsKICAgIG5vZGVzID0gbjsKICAgIGJvdW5kcyA9IG5vZGVzLm1hcChub2RlID0+IHsKICAgICAgY29uc3Qgbm9kZUJvdW5kcyA9IG5vZGUuYWxsb3dlZFlSYW5nZShncmFwaEhlaWdodCk7CiAgICAgIC8vIExlYXZlIHNwYWNlIGZvciB0aGUgbm9kZSBjaXJjbGUgcGx1cyBhIHNtYWxsIGJvcmRlci4KICAgICAgbm9kZUJvdW5kc1swXSArPSBrTm9kZVJhZGl1cyAqIDI7CiAgICAgIG5vZGVCb3VuZHNbMV0gLT0ga05vZGVSYWRpdXMgKiAyOwogICAgICByZXR1cm4gbm9kZUJvdW5kczsKICAgIH0pOwogIH07CgogIHJldHVybiBmb3JjZTsKfQoKLyoqCiAqIEBpbXBsZW1lbnRzIHtkaXNjYXJkcy5tb2pvbS5HcmFwaENoYW5nZVN0cmVhbUludGVyZmFjZX0KICovCmNsYXNzIEdyYXBoIHsKICAvKioKICAgKiBUT0RPKHNpZ2dpKTogVGhpcyBzaG91bGQgYmUgU1ZHRWxlbWVudCwgYnV0IGNsb3N1cmUgZG9lc24ndCBoYXZlIGV4dGVybnMKICAgKiAgICBmb3IgdGhpcyB5ZXQuCiAgICogQHBhcmFtIHtFbGVtZW50fSBzdmcKICAgKiBAcGFyYW0ge0VsZW1lbnR9IGRpdgogICAqLwogIGNvbnN0cnVjdG9yKHN2ZywgZGl2KSB7CiAgICAvKioKICAgICAqIFRPRE8oc2lnZ2kpOiBTVkdFbGVtZW50LgogICAgICogQHByaXZhdGUge0VsZW1lbnR9CiAgICAgKi8KICAgIHRoaXMuc3ZnXyA9IHN2ZzsKCiAgICAvKiogQHByaXZhdGUge0VsZW1lbnR9ICovCiAgICB0aGlzLmRpdl8gPSBkaXY7CgogICAgLyoqIEBwcml2YXRlIHtib29sZWFufSAqLwogICAgdGhpcy53YXNSZXNpemVkXyA9IGZhbHNlOwoKICAgIC8qKiBAcHJpdmF0ZSB7bnVtYmVyfSAqLwogICAgdGhpcy53aWR0aF8gPSAwOwogICAgLyoqIEBwcml2YXRlIHtudW1iZXJ9ICovCiAgICB0aGlzLmhlaWdodF8gPSAwOwoKICAgIC8qKiBAcHJpdmF0ZSB7ZDMuRm9yY2VTaW11bGF0aW9ufSAqLwogICAgdGhpcy5zaW11bGF0aW9uXyA9IG51bGw7CgogICAgLyoqCiAgICAgKiBBIHNlbGVjdGlvbiBmb3IgdGhlIHRvcC1sZXZlbCA8Zz4gbm9kZSB0aGF0IGNvbnRhaW5zIGFsbCB0b29sdGlwIGxpbmtzLgogICAgICogQHByaXZhdGUge2QzLnNlbGVjdGlvbn0KICAgICAqLwogICAgdGhpcy50b29sVGlwTGlua0dyb3VwXyA9IG51bGw7CgogICAgLyoqCiAgICAgKiBBIHNlbGVjdGlvbiBmb3IgdGhlIHRvcC1sZXZlbCA8Zz4gbm9kZSB0aGF0IGNvbnRhaW5zIGFsbCBzZXBhcmF0b3JzLgogICAgICogQHByaXZhdGUge2QzLnNlbGVjdGlvbn0KICAgICAqLwogICAgdGhpcy5zZXBhcmF0b3JHcm91cF8gPSBudWxsOwoKICAgIC8qKgogICAgICogQSBzZWxlY3Rpb24gZm9yIHRoZSB0b3AtbGV2ZWwgPGc+IG5vZGUgdGhhdCBjb250YWlucyBhbGwgbm9kZXMuCiAgICAgKiBAcHJpdmF0ZSB7ZDMuc2VsZWN0aW9ufQogICAgICovCiAgICB0aGlzLm5vZGVHcm91cF8gPSBudWxsOwoKICAgIC8qKgogICAgICogQSBzZWxlY3Rpb24gZm9yIHRoZSB0b3AtbGV2ZWwgPGc+IG5vZGUgdGhhdCBjb250YWlucyBhbGwgZWRnZXMuCiAgICAgKiBAcHJpdmF0ZSB7ZDMuc2VsZWN0aW9ufQogICAgICovCiAgICB0aGlzLmxpbmtHcm91cF8gPSBudWxsOwoKICAgIC8qKgogICAgICogQSBzZWxlY3Rpb24gZm9yIHRoZSB0b3AtbGV2ZWwgPGc+IG5vZGUgdGhhdCBjb250YWlucyBhbGwgZGFzaGVkIGVkZ2VzLgogICAgICogQHByaXZhdGUge2QzLnNlbGVjdGlvbn0KICAgICAqLwogICAgdGhpcy5kYXNoZWRMaW5rR3JvdXBfID0gbnVsbDsKCiAgICAvKiogQHByaXZhdGUgeyFNYXA8bnVtYmVyLCAhR3JhcGhOb2RlPn0gKi8KICAgIHRoaXMubm9kZXNfID0gbmV3IE1hcCgpOwoKICAgIC8qKgogICAgICogVGhlIGxpbmtzLgogICAgICogQHByaXZhdGUgeyFBcnJheTwhZDMuRm9yY2VMaW5rPn0KICAgICAqLwogICAgdGhpcy5saW5rc18gPSBbXTsKCiAgICAvKioKICAgICAqIFRoZSBkYXNoZWQgbGlua3MuCiAgICAgKiBAcHJpdmF0ZSB7IUFycmF5PCFkMy5Gb3JjZUxpbms+fQogICAgICovCiAgICB0aGlzLmRhc2hlZExpbmtzXyA9IFtdOwoKICAgIC8qKgogICAgICogVGhlIGhvc3Qgd2luZG93LgogICAgICogQHByaXZhdGUge1dpbmRvd30KICAgICAqLwogICAgdGhpcy5ob3N0V2luZG93XyA9IG51bGw7CgogICAgLyoqCiAgICAgKiBUaGUgaW50ZXJ2YWwgdGltZXIgdXNlZCB0byBwb2xsIGZvciBub2RlIGRlc2NyaXB0aW9ucy4KICAgICAqIEBwcml2YXRlIHtudW1iZXJ9CiAgICAgKi8KICAgIHRoaXMucG9sbERlc2NyaXB0aW9uc0ludGVydmFsXyA9IDA7CgogICAgLyoqCiAgICAgKiBUaGUgZDMuZHJhZyBpbnN0YW5jZSBhcHBsaWVkIHRvIG5vZGVzLgogICAgICogQHByaXZhdGUgez9kMy5EcmFnfQogICAgICovCiAgICB0aGlzLmRyYWdfID0gbnVsbDsKICB9CgogIGluaXRpYWxpemUoKSB7CiAgICAvLyBTZXQgdXAgYSBtZXNzYWdlIGxpc3RlbmVyIHRvIHJlY2VpdmUgdGhlIGdyYXBoIGRhdGEgZnJvbSB0aGUgV2ViVUkuCiAgICAvLyBUaGlzIGlzIGhvc3RlZCBpbiBhIHdlYnZpZXcgdGhhdCBpcyBuZXZlciBuYXZpZ2F0ZWQgYW55d2hlcmUgZWxzZSwKICAgIC8vIHNvIHRoZXNlIGV2ZW50IGhhbmRsZXJzIGFyZSBuZXZlciByZW1vdmVkLgogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCB0aGlzLm9uTWVzc2FnZV8uYmluZCh0aGlzKSk7CgogICAgLy8gU2V0IHVwIGEgcmVzaXplIGxpc3RlbmVyIHRvIHRyYWNrIHRoZSBncmFwaCBvbiByZXNpemUuCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgdGhpcy5vblJlc2l6ZV8uYmluZCh0aGlzKSk7CgogICAgLy8gQ3JlYXRlIHRoZSBzaW11bGF0aW9uIGFuZCBzZXQgdXAgdGhlIHBlcm1hbmVudCBmb3JjZXMuCiAgICBjb25zdCBzaW11bGF0aW9uID0gZDMuZm9yY2VTaW11bGF0aW9uKCk7CiAgICBzaW11bGF0aW9uLm9uKCd0aWNrJywgdGhpcy5vblRpY2tfLmJpbmQodGhpcykpOwoKICAgIGNvbnN0IGxpbmtGb3JjZSA9IGQzLmZvcmNlTGluaygpLmlkKGQgPT4gZC5pZCk7CiAgICBjb25zdCBkZWZhdWx0U3RyZW5ndGggPSBsaW5rRm9yY2Uuc3RyZW5ndGgoKTsKCiAgICAvLyBPdmVycmlkZSB0aGUgZGVmYXVsdCBsaW5rIHN0cmVuZ3RoIGZ1bmN0aW9uIHRvIGFwcGx5IHNjYWxpbmcgZmFjdG9ycwogICAgLy8gZnJvbSB0aGUgc291cmNlIGFuZCB0YXJnZXQgbm9kZXMgdG8gdGhlIGxpbmsgc3RyZW5ndGguIFRoaXMgbGV0cwogICAgLy8gZGlmZmVyZW50IG5vZGUgdHlwZXMgYmFsYW5jZSBsaW5rIGZvcmNlcyB3aXRoIG90aGVyIGZvcmNlcyB0aGF0IGFjdCBvbgogICAgLy8gdGhlbS4KICAgIHNpbXVsYXRpb24uZm9yY2UoCiAgICAgICAgJ2xpbmsnLAogICAgICAgIGxpbmtGb3JjZS5zdHJlbmd0aCgKICAgICAgICAgICAgbCA9PiBkZWZhdWx0U3RyZW5ndGgobCkgKiBsLnNvdXJjZS5saW5rU3RyZW5ndGhTY2FsaW5nRmFjdG9yICoKICAgICAgICAgICAgICAgIGwudGFyZ2V0LmxpbmtTdHJlbmd0aFNjYWxpbmdGYWN0b3IpKTsKCiAgICAvLyBTZXRzIHRoZSByZXB1bHNpb24gZm9yY2UgYmV0d2VlbiBub2RlcyAocG9zaXRpdmUgbnVtYmVyIGlzIGF0dHJhY3Rpb24sCiAgICAvLyBuZWdhdGl2ZSBudW1iZXIgaXMgcmVwdWxzaW9uKS4KICAgIHNpbXVsYXRpb24uZm9yY2UoCiAgICAgICAgJ2NoYXJnZScsCiAgICAgICAgZDMuZm9yY2VNYW55Qm9keSgpLnN0cmVuZ3RoKHRoaXMuZ2V0TWFueUJvZHlTdHJlbmd0aF8uYmluZCh0aGlzKSkpOwoKICAgIHRoaXMuc2ltdWxhdGlvbl8gPSBzaW11bGF0aW9uOwoKICAgIC8vIENyZWF0ZSB0aGUgPGc+IGVsZW1lbnRzIHRoYXQgaG9zdCBub2RlcyBhbmQgbGlua3MuCiAgICAvLyBUaGUgbGluayBncm91cHMgYXJlIGNyZWF0ZWQgZmlyc3Qgc28gdGhhdCBhbGwgbGlua3MgZW5kIHVwIGJlaGluZCBub2Rlcy4KICAgIGNvbnN0IHN2ZyA9IGQzLnNlbGVjdCh0aGlzLnN2Z18pOwogICAgdGhpcy50b29sVGlwTGlua0dyb3VwXyA9IHN2Zy5hcHBlbmQoJ2cnKS5hdHRyKCdjbGFzcycsICd0b29sLXRpcC1saW5rcycpOwogICAgdGhpcy5saW5rR3JvdXBfID0gc3ZnLmFwcGVuZCgnZycpLmF0dHIoJ2NsYXNzJywgJ2xpbmtzJyk7CiAgICB0aGlzLmRhc2hlZExpbmtHcm91cF8gPSBzdmcuYXBwZW5kKCdnJykuYXR0cignY2xhc3MnLCAnZGFzaGVkLWxpbmtzJyk7CiAgICB0aGlzLm5vZGVHcm91cF8gPSBzdmcuYXBwZW5kKCdnJykuYXR0cignY2xhc3MnLCAnbm9kZXMnKTsKICAgIHRoaXMuc2VwYXJhdG9yR3JvdXBfID0gc3ZnLmFwcGVuZCgnZycpLmF0dHIoJ2NsYXNzJywgJ3NlcGFyYXRvcnMnKTsKCiAgICBjb25zdCBkcmFnID0gZDMuZHJhZygpOwogICAgZHJhZy5jbGlja0Rpc3RhbmNlKDQpOwogICAgZHJhZy5vbignc3RhcnQnLCB0aGlzLm9uRHJhZ1N0YXJ0Xy5iaW5kKHRoaXMpKTsKICAgIGRyYWcub24oJ2RyYWcnLCB0aGlzLm9uRHJhZ18uYmluZCh0aGlzKSk7CiAgICBkcmFnLm9uKCdlbmQnLCB0aGlzLm9uRHJhZ0VuZF8uYmluZCh0aGlzKSk7CiAgICB0aGlzLmRyYWdfID0gZHJhZzsKICB9CgogIC8qKiBAb3ZlcnJpZGUgKi8KICBmcmFtZUNyZWF0ZWQoZnJhbWUpIHsKICAgIHRoaXMuYWRkTm9kZV8obmV3IEZyYW1lTm9kZShmcmFtZSkpOwogIH0KCiAgLyoqIEBvdmVycmlkZSAqLwogIHBhZ2VDcmVhdGVkKHBhZ2UpIHsKICAgIHRoaXMuYWRkTm9kZV8obmV3IFBhZ2VOb2RlKHBhZ2UpKTsKICB9CgogIC8qKiBAb3ZlcnJpZGUgKi8KICBwcm9jZXNzQ3JlYXRlZChwcm9jZXNzKSB7CiAgICB0aGlzLmFkZE5vZGVfKG5ldyBQcm9jZXNzTm9kZShwcm9jZXNzKSk7CiAgfQoKICAvKiogQG92ZXJyaWRlICovCiAgd29ya2VyQ3JlYXRlZCh3b3JrZXIpIHsKICAgIHRoaXMuYWRkTm9kZV8obmV3IFdvcmtlck5vZGUod29ya2VyKSk7CiAgfQoKICAvKiogQG92ZXJyaWRlICovCiAgZnJhbWVDaGFuZ2VkKGZyYW1lKSB7CiAgICBjb25zdCBmcmFtZU5vZGUgPSAvKiogQHR5cGUgeyFGcmFtZU5vZGV9ICovICh0aGlzLm5vZGVzXy5nZXQoZnJhbWUuaWQpKTsKICAgIGZyYW1lTm9kZS5mcmFtZSA9IGZyYW1lOwogIH0KCiAgLyoqIEBvdmVycmlkZSAqLwogIHBhZ2VDaGFuZ2VkKHBhZ2UpIHsKICAgIGNvbnN0IHBhZ2VOb2RlID0gLyoqIEB0eXBlIHshUGFnZU5vZGV9ICovICh0aGlzLm5vZGVzXy5nZXQocGFnZS5pZCkpOwoKICAgIC8vIFBhZ2Ugbm9kZSBkYXNoZWQgbGlua3MgbWF5IGNoYW5nZSBkeW5hbWljYWxseSwgc28gYWNjb3VudCBmb3IgdGhhdCBoZXJlLgogICAgdGhpcy5yZW1vdmVEYXNoZWROb2RlTGlua3NfKHBhZ2VOb2RlKTsKICAgIHBhZ2VOb2RlLnBhZ2UgPSBwYWdlOwogICAgdGhpcy5hZGREYXNoZWROb2RlTGlua3NfKHBhZ2VOb2RlKTsKICB9CgogIC8qKiBAb3ZlcnJpZGUgKi8KICBwcm9jZXNzQ2hhbmdlZChwcm9jZXNzKSB7CiAgICBjb25zdCBwcm9jZXNzTm9kZSA9CiAgICAgICAgLyoqIEB0eXBlIHshUHJvY2Vzc05vZGV9ICovICh0aGlzLm5vZGVzXy5nZXQocHJvY2Vzcy5pZCkpOwogICAgcHJvY2Vzc05vZGUucHJvY2VzcyA9IHByb2Nlc3M7CiAgfQoKICAvKiogQG92ZXJyaWRlICovCiAgd29ya2VyQ2hhbmdlZCh3b3JrZXIpIHsKICAgIGNvbnN0IHdvcmtlck5vZGUgPQogICAgICAgIC8qKiBAdHlwZSB7IVdvcmtlck5vZGV9ICovICh0aGlzLm5vZGVzXy5nZXQod29ya2VyLmlkKSk7CgogICAgLy8gV29ya2VyIG5vZGUgbGlua3MgbWF5IGNoYW5nZSBkeW5hbWljYWxseSwgc28gYWNjb3VudCBmb3IgdGhhdCBoZXJlLgogICAgdGhpcy5yZW1vdmVOb2RlTGlua3NfKHdvcmtlck5vZGUpOwogICAgd29ya2VyTm9kZS53b3JrZXIgPSB3b3JrZXI7CiAgICB0aGlzLmFkZE5vZGVMaW5rc18od29ya2VyTm9kZSk7CiAgfQoKICAvKiogQG92ZXJyaWRlICovCiAgZmF2SWNvbkRhdGFBdmFpbGFibGUoaWNvbkluZm8pIHsKICAgIGNvbnN0IGdyYXBoTm9kZSA9IHRoaXMubm9kZXNfLmdldChpY29uSW5mby5ub2RlSWQpOwogICAgaWYgKGdyYXBoTm9kZSkgewogICAgICBncmFwaE5vZGUuaWNvblVybCA9ICdkYXRhOmltYWdlL3BuZztiYXNlNjQsJyArIGljb25JbmZvLmljb25EYXRhOwogICAgfQogIH0KCiAgLyoqIEBvdmVycmlkZSAqLwogIG5vZGVEZWxldGVkKG5vZGVJZCkgewogICAgY29uc3Qgbm9kZSA9IHRoaXMubm9kZXNfLmdldChub2RlSWQpOwoKICAgIC8vIFJlbW92ZSBhbnkgbGlua3MsIGFuZCB0aGVuIHRoZSBub2RlIGl0c2VsZi4KICAgIHRoaXMucmVtb3ZlTm9kZUxpbmtzXyhub2RlKTsKICAgIHRoaXMucmVtb3ZlRGFzaGVkTm9kZUxpbmtzXyhub2RlKTsKICAgIHRoaXMubm9kZXNfLmRlbGV0ZShub2RlSWQpOwogIH0KCiAgLyoqIFVwZGF0ZXMgZmxvYXRpbmcgdG9vbHRpcCBwb3NpdGlvbnMgYXMgd2VsbCBhcyBsaW5rcyB0byBwaW5uZWQgdG9vbHRpcHMgKi8KICB1cGRhdGVUb29sVGlwTGlua3MoKSB7CiAgICBjb25zdCBwaW5uZWRUb29sdGlwcyA9IFtdOwogICAgZm9yIChjb25zdCBub2RlIG9mIHRoaXMubm9kZXNfLnZhbHVlcygpKSB7CiAgICAgIGNvbnN0IHRvb2x0aXAgPSBub2RlLnRvb2x0aXA7CgogICAgICBpZiAodG9vbHRpcCkgewogICAgICAgIGlmICh0b29sdGlwLmZsb2F0aW5nKSB7CiAgICAgICAgICB0b29sdGlwLm5vZGVNb3ZlZCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwaW5uZWRUb29sdGlwcy5wdXNoKHRvb2x0aXApOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHNldExpbmVFbmRwb2ludHMoZCkgewogICAgICBjb25zdCBsaW5lID0gZDMuc2VsZWN0KHRoaXMpOwogICAgICBjb25zdCBjZW50ZXIgPSBkLmdldENlbnRlcigpOwogICAgICBsaW5lLmF0dHIoJ3gxJywgZCA9PiBjZW50ZXJbMF0pCiAgICAgICAgICAuYXR0cigneTEnLCBkID0+IGNlbnRlclsxXSkKICAgICAgICAgIC5hdHRyKCd4MicsIGQgPT4gZC5ub2RlLngpCiAgICAgICAgICAuYXR0cigneTInLCBkID0+IGQubm9kZS55KTsKICAgIH0KCiAgICBjb25zdCB0b29sVGlwTGlua3MgPQogICAgICAgIHRoaXMudG9vbFRpcExpbmtHcm91cF8uc2VsZWN0QWxsKCdsaW5lJykuZGF0YShwaW5uZWRUb29sdGlwcyk7CiAgICB0b29sVGlwTGlua3MuZW50ZXIoKQogICAgICAgIC5hcHBlbmQoJ2xpbmUnKQogICAgICAgIC5hdHRyKCdzdHJva2UnLCAnTGlnaHRHcmF5JykKICAgICAgICAuYXR0cignc3Ryb2tlLWRhc2hhcnJheScsICcxJykKICAgICAgICAuYXR0cignc3Ryb2tlLW9wYWNpdHknLCAnMC44JykKICAgICAgICAuZWFjaChzZXRMaW5lRW5kcG9pbnRzKTsKICAgIHRvb2xUaXBMaW5rcy5lYWNoKHNldExpbmVFbmRwb2ludHMpOwogICAgdG9vbFRpcExpbmtzLmV4aXQoKS5yZW1vdmUoKTsKICB9CgogIC8qKgogICAqIEBwYXJhbSB7IUdyYXBoTm9kZX0gbm9kZQogICAqIEBwcml2YXRlCiAgICovCiAgcmVtb3ZlTm9kZUxpbmtzXyhub2RlKSB7CiAgICAvLyBGaWx0ZXIgYXdheSBhbnkgbGlua3MgdG8gb3IgZnJvbSB0aGUgcHJvdmlkZWQgbm9kZS4KICAgIHRoaXMubGlua3NfID0gdGhpcy5saW5rc18uZmlsdGVyKAogICAgICAgIGxpbmsgPT4gbGluay5zb3VyY2UgIT09IG5vZGUgJiYgbGluay50YXJnZXQgIT09IG5vZGUpOwogIH0KCiAgLyoqCiAgICogQHBhcmFtIHshR3JhcGhOb2RlfSBub2RlCiAgICogQHByaXZhdGUKICAgKi8KICByZW1vdmVEYXNoZWROb2RlTGlua3NfKG5vZGUpIHsKICAgIC8vIEZpbHRlciBhd2F5IGFueSBkYXNoZWQgbGlua3MgdG8gb3IgZnJvbSB0aGUgcHJvdmlkZWQgbm9kZS4KICAgIHRoaXMuZGFzaGVkTGlua3NfID0gdGhpcy5kYXNoZWRMaW5rc18uZmlsdGVyKAogICAgICAgIGxpbmsgPT4gbGluay5zb3VyY2UgIT09IG5vZGUgJiYgbGluay50YXJnZXQgIT09IG5vZGUpOwogIH0KCiAgLyoqCiAgICogQHBhcmFtIHshT2JqZWN0PHN0cmluZz59IG5vZGVEZXNjcmlwdGlvbnMKICAgKiBAcHJpdmF0ZQogICAqLwogIG5vZGVEZXNjcmlwdGlvbnNfKG5vZGVEZXNjcmlwdGlvbnMpIHsKICAgIGZvciAoY29uc3Qgbm9kZUlkIGluIG5vZGVEZXNjcmlwdGlvbnMpIHsKICAgICAgY29uc3Qgbm9kZSA9IHRoaXMubm9kZXNfLmdldChOdW1iZXIucGFyc2VJbnQobm9kZUlkLCAxMCkpOwogICAgICBpZiAobm9kZSAmJiBub2RlLnRvb2x0aXApIHsKICAgICAgICBub2RlLnRvb2x0aXAub25EZXNjcmlwdGlvbihub2RlRGVzY3JpcHRpb25zW25vZGVJZF0pOwogICAgICB9CiAgICB9CiAgfQoKICAvKioKICAgKiBAcHJpdmF0ZQogICAqLwogIHBvbGxGb3JOb2RlRGVzY3JpcHRpb25zXygpIHsKICAgIGNvbnN0IG5vZGVJZHMgPSBbXTsKICAgIGZvciAoY29uc3Qgbm9kZSBvZiB0aGlzLm5vZGVzXy52YWx1ZXMoKSkgewogICAgICBpZiAobm9kZS50b29sdGlwKSB7CiAgICAgICAgbm9kZUlkcy5wdXNoKG5vZGUuaWQpOwogICAgICB9CiAgICB9CgogICAgaWYgKG5vZGVJZHMubGVuZ3RoKSB7CiAgICAgIHRoaXMuaG9zdFdpbmRvd18ucG9zdE1lc3NhZ2UoWydyZXF1ZXN0Tm9kZURlc2NyaXB0aW9ucycsIG5vZGVJZHNdLCAnKicpOwoKICAgICAgaWYgKHRoaXMucG9sbERlc2NyaXB0aW9uc0ludGVydmFsXyA9PT0gMCkgewogICAgICAgIC8vIFN0YXJ0IHBvbGxpbmcgaWYgbm90IGFscmVhZHkgaW4gcHJvZ3Jlc3MuCiAgICAgICAgdGhpcy5wb2xsRGVzY3JpcHRpb25zSW50ZXJ2YWxfID0KICAgICAgICAgICAgc2V0SW50ZXJ2YWwodGhpcy5wb2xsRm9yTm9kZURlc2NyaXB0aW9uc18uYmluZCh0aGlzKSwgMTAwMCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIE5vIHRvb2x0aXBzLCBzdG9wIHBvbGxpbmcuCiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5wb2xsRGVzY3JpcHRpb25zSW50ZXJ2YWxfKTsKICAgICAgdGhpcy5wb2xsRGVzY3JpcHRpb25zSW50ZXJ2YWxfID0gMDsKICAgIH0KICB9CgogIC8qKgogICAqIEBwYXJhbSB7IUV2ZW50fSBldmVudCBBIGdyYXBoIHVwZGF0ZSBldmVudCBwb3N0ZWQgZnJvbSB0aGUgV2ViVUkuCiAgICogQHByaXZhdGUKICAgKi8KICBvbk1lc3NhZ2VfKGV2ZW50KSB7CiAgICBpZiAoIXRoaXMuaG9zdFdpbmRvd18pIHsKICAgICAgdGhpcy5ob3N0V2luZG93XyA9IGV2ZW50LnNvdXJjZTsKICAgIH0KCiAgICBjb25zdCB0eXBlID0gLyoqIEB0eXBlIHtzdHJpbmd9ICovIChldmVudC5kYXRhWzBdKTsKICAgIGNvbnN0IGRhdGEgPSAvKiogQHR5cGUge09iamVjdHxudW1iZXJ9ICovIChldmVudC5kYXRhWzFdKTsKICAgIHN3aXRjaCAodHlwZSkgewogICAgICBjYXNlICdmcmFtZUNyZWF0ZWQnOgogICAgICAgIHRoaXMuZnJhbWVDcmVhdGVkKAogICAgICAgICAgICAvKiogQHR5cGUgeyFkaXNjYXJkcy5tb2pvbS5GcmFtZUluZm99ICovIChkYXRhKSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ3BhZ2VDcmVhdGVkJzoKICAgICAgICB0aGlzLnBhZ2VDcmVhdGVkKAogICAgICAgICAgICAvKiogQHR5cGUgeyFkaXNjYXJkcy5tb2pvbS5QYWdlSW5mb30gKi8gKGRhdGEpKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAncHJvY2Vzc0NyZWF0ZWQnOgogICAgICAgIHRoaXMucHJvY2Vzc0NyZWF0ZWQoCiAgICAgICAgICAgIC8qKiBAdHlwZSB7IWRpc2NhcmRzLm1vam9tLlByb2Nlc3NJbmZvfSAqLyAoZGF0YSkpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICd3b3JrZXJDcmVhdGVkJzoKICAgICAgICB0aGlzLndvcmtlckNyZWF0ZWQoCiAgICAgICAgICAgIC8qKiBAdHlwZSB7IWRpc2NhcmRzLm1vam9tLldvcmtlckluZm99ICovIChkYXRhKSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ2ZyYW1lQ2hhbmdlZCc6CiAgICAgICAgdGhpcy5mcmFtZUNoYW5nZWQoCiAgICAgICAgICAgIC8qKiBAdHlwZSB7IWRpc2NhcmRzLm1vam9tLkZyYW1lSW5mb30gKi8gKGRhdGEpKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAncGFnZUNoYW5nZWQnOgogICAgICAgIHRoaXMucGFnZUNoYW5nZWQoCiAgICAgICAgICAgIC8qKiBAdHlwZSB7IWRpc2NhcmRzLm1vam9tLlBhZ2VJbmZvfSAqLyAoZGF0YSkpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdwcm9jZXNzQ2hhbmdlZCc6CiAgICAgICAgdGhpcy5wcm9jZXNzQ2hhbmdlZCgKICAgICAgICAgICAgLyoqIEB0eXBlIHshZGlzY2FyZHMubW9qb20uUHJvY2Vzc0luZm99ICovIChkYXRhKSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ2Zhdkljb25EYXRhQXZhaWxhYmxlJzoKICAgICAgICB0aGlzLmZhdkljb25EYXRhQXZhaWxhYmxlKAogICAgICAgICAgICAvKiogQHR5cGUgeyFkaXNjYXJkcy5tb2pvbS5GYXZJY29uSW5mb30gKi8gKGRhdGEpKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnd29ya2VyQ2hhbmdlZCc6CiAgICAgICAgdGhpcy53b3JrZXJDaGFuZ2VkKAogICAgICAgICAgICAvKiogQHR5cGUgeyFkaXNjYXJkcy5tb2pvbS5Xb3JrZXJJbmZvfSAqLyAoZGF0YSkpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdub2RlRGVsZXRlZCc6CiAgICAgICAgdGhpcy5ub2RlRGVsZXRlZCgvKiogQHR5cGUge251bWJlcn0gKi8gKGRhdGEpKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnbm9kZURlc2NyaXB0aW9ucyc6CiAgICAgICAgdGhpcy5ub2RlRGVzY3JpcHRpb25zXygvKiogQHR5cGUgeyFPYmplY3Q8c3RyaW5nPn0gKi8gKGRhdGEpKTsKICAgICAgICBicmVhazsKICAgIH0KCiAgICB0aGlzLnJlbmRlcl8oKTsKICB9CgogIC8qKgogICAqIEBwYXJhbSB7R3JhcGhOb2RlfSBub2RlCiAgICogQHByaXZhdGUKICAgKi8KICBvbkdyYXBoTm9kZUNsaWNrXyhub2RlKSB7CiAgICBpZiAobm9kZS50b29sdGlwKSB7CiAgICAgIG5vZGUudG9vbHRpcC5nb0F3YXkoKTsKICAgICAgbm9kZS50b29sdGlwID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG5vZGUudG9vbHRpcCA9IG5ldyBUb29sVGlwKHRoaXMuZGl2Xywgbm9kZSk7CgogICAgICAvLyBQb2xsIGZvciBhbGwgdG9vbHRpcCBub2RlIGRlc2NyaXB0aW9ucyBpbW1lZGlhdGVseS4KICAgICAgdGhpcy5wb2xsRm9yTm9kZURlc2NyaXB0aW9uc18oKTsKICAgIH0KICB9CgogIC8qKgogICAqIFJlbmRlcnMgbm9kZXNfIGFuZCBlZGdlc18gdG8gdGhlIFNWRyBET00uCiAgICoKICAgKiBFYWNoIGVkZ2UgaXMgYSBsaW5lIGVsZW1lbnQuCiAgICogRWFjaCBub2RlIGlzIHJlcHJlc2VudGVkIGFzIGEgZ3JvdXAgZWxlbWVudCB3aXRoIHRocmVlIGNoaWxkcmVuOgogICAqICAgMS4gQSBjaXJjbGUgdGhhdCBoYXMgYSBjb2xvciBhbmQgd2hpY2ggYW5pbWF0ZXMgdGhlIG5vZGUgb24gY3JlYXRpb24KICAgKiAgICAgIGFuZCBkZWxldGlvbi4KICAgKiAgIDIuIEFuIGltYWdlIHRoYXQgaXMgcHJvdmlkZWQgYSBkYXRhIFVSTCBmb3IgdGhlIG5vZGVzIGZhdmljb24sIHdoZW4KICAgKiAgICAgIGF2YWlsYWJsZS4KICAgKiAgIDMuIEEgdGl0bGUgZWxlbWVudCB0aGF0IHByZXNlbnRzIHRoZSBub2RlcyBVUkwgb24gaG92ZXItb3ZlciwgaWYKICAgKiAgICAgIGF2YWlsYWJsZS4KICAgKiBEZWxldGVkIG5vZGVzIGFyZSBjbGFzc2VkICcuZGVhZCcsIGFuZCBDU1MgdGFrZXMgY2FyZSBvZiBoaWRpbmcgdGhlaXIKICAgKiBpbWFnZSBlbGVtZW50IGlmIGl0J3MgYmVlbiBwb3B1bGF0ZWQgd2l0aCBhbiBpY29uLgogICAqCiAgICogQHByaXZhdGUKICAgKi8KICByZW5kZXJfKCkgewogICAgLy8gU2VsZWN0IHRoZSBsaW5rcy4KICAgIGNvbnN0IGxpbmsgPSB0aGlzLmxpbmtHcm91cF8uc2VsZWN0QWxsKCdsaW5lJykuZGF0YSh0aGlzLmxpbmtzXyk7CiAgICAvLyBBZGQgbmV3IGxpbmtzLgogICAgbGluay5lbnRlcigpLmFwcGVuZCgnbGluZScpOwogICAgLy8gUmVtb3ZlIGRlYWQgbGlua3MuCiAgICBsaW5rLmV4aXQoKS5yZW1vdmUoKTsKCiAgICAvLyBTZWxlY3QgdGhlIGRhc2hlZCBsaW5rcy4KICAgIGNvbnN0IGRhc2hlZExpbmsgPQogICAgICAgIHRoaXMuZGFzaGVkTGlua0dyb3VwXy5zZWxlY3RBbGwoJ2xpbmUnKS5kYXRhKHRoaXMuZGFzaGVkTGlua3NfKTsKICAgIC8vIEFkZCBuZXcgZGFzaGVkIGxpbmtzLgogICAgZGFzaGVkTGluay5lbnRlcigpLmFwcGVuZCgnbGluZScpOwogICAgLy8gUmVtb3ZlIGRlYWQgZGFzaGVkIGxpbmtzLgogICAgZGFzaGVkTGluay5leGl0KCkucmVtb3ZlKCk7CgogICAgLy8gU2VsZWN0IHRoZSBub2RlcywgZXhjZXB0IGZvciBhbnkgZGVhZCBvbmVzIHRoYXQgYXJlIHN0aWxsIHRyYW5zaXRpb25pbmcuCiAgICBjb25zdCBub2RlcyA9IEFycmF5LmZyb20odGhpcy5ub2Rlc18udmFsdWVzKCkpOwogICAgY29uc3Qgbm9kZSA9CiAgICAgICAgdGhpcy5ub2RlR3JvdXBfLnNlbGVjdEFsbCgnZzpub3QoLmRlYWQpJykuZGF0YShub2RlcywgZCA9PiBkLmlkKTsKCiAgICAvLyBBZGQgbmV3IG5vZGVzLCBpZiBhbnkuCiAgICBpZiAoIW5vZGUuZW50ZXIoKS5lbXB0eSgpKSB7CiAgICAgIGNvbnN0IG5ld05vZGVzID0gbm9kZS5lbnRlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgIC5hcHBlbmQoJ2cnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAuY2FsbCh0aGlzLmRyYWdfKQogICAgICAgICAgICAgICAgICAgICAgICAgICAub24oJ2NsaWNrJywgdGhpcy5vbkdyYXBoTm9kZUNsaWNrXy5iaW5kKHRoaXMpKTsKICAgICAgY29uc3QgY2lyY2xlcyA9IG5ld05vZGVzLmFwcGVuZCgnY2lyY2xlJykKICAgICAgICAgICAgICAgICAgICAgICAgICAuYXR0cignaWQnLCBkID0+IGBjaXJjbGUtJHtkLmlkfWApCiAgICAgICAgICAgICAgICAgICAgICAgICAgLmF0dHIoJ3InLCBrTm9kZVJhZGl1cyAqIDEuNSkKICAgICAgICAgICAgICAgICAgICAgICAgICAuYXR0cignZmlsbCcsICdncmVlbicpOyAgLy8gTmV3IG5vZGVzIGFwcGVhciBncmVlbi4KCiAgICAgIG5ld05vZGVzLmFwcGVuZCgnaW1hZ2UnKQogICAgICAgICAgLmF0dHIoJ3gnLCAtOCkKICAgICAgICAgIC5hdHRyKCd5JywgLTgpCiAgICAgICAgICAuYXR0cignd2lkdGgnLCAxNikKICAgICAgICAgIC5hdHRyKCdoZWlnaHQnLCAxNik7CiAgICAgIG5ld05vZGVzLmFwcGVuZCgndGl0bGUnKTsKCiAgICAgIC8vIFRyYW5zaXRpb24gbmV3IG5vZGVzIHRvIHRoZWlyIGNob3NlbiBjb2xvciBpbiAyIHNlY29uZHMuCiAgICAgIGNpcmNsZXMudHJhbnNpdGlvbigpCiAgICAgICAgICAuZHVyYXRpb24oMjAwMCkKICAgICAgICAgIC5hdHRyKCdmaWxsJywgZCA9PiBkLmNvbG9yKQogICAgICAgICAgLmF0dHIoJ3InLCBrTm9kZVJhZGl1cyk7CiAgICB9CgogICAgaWYgKCFub2RlLmV4aXQoKS5lbXB0eSgpKSB7CiAgICAgIC8vIEdpdmUgZGVhZCBub2RlcyBhIGRpc3Rpbmd1aXNoaW5nIGNsYXNzIHRvIGV4Y2x1ZGUgdGhlbSBmcm9tIHRoZQogICAgICAvLyBzZWxlY3Rpb24gYWJvdmUuCiAgICAgIGNvbnN0IGRlbGV0ZWROb2RlcyA9IG5vZGUuZXhpdCgpLmNsYXNzZWQoJ2RlYWQnLCB0cnVlKTsKCiAgICAgIC8vIEludGVycnVwdCBhbnkgb25nb2luZyB0cmFuc2l0aW9ucy4KICAgICAgZGVsZXRlZE5vZGVzLmludGVycnVwdCgpOwoKICAgICAgLy8gVHVybiBkb3duIHRoZSBub2RlIGFzc29jaWF0ZWQgdG9vbHRpcHMuCiAgICAgIGRlbGV0ZWROb2Rlcy5lYWNoKGQgPT4gewogICAgICAgIGlmIChkLnRvb2x0aXApIHsKICAgICAgICAgIGQudG9vbHRpcC5nb0F3YXkoKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgLy8gVHJhbnNpdGlvbiB0aGUgbm9kZXMgb3V0IGFuZCByZW1vdmUgdGhlbSBhdCB0aGUgZW5kIG9mIHRyYW5zaXRpb24uCiAgICAgIGRlbGV0ZWROb2Rlcy50cmFuc2l0aW9uKCkKICAgICAgICAgIC5yZW1vdmUoKQogICAgICAgICAgLnNlbGVjdCgnY2lyY2xlJykKICAgICAgICAgIC5hdHRyKCdyJywgOSkKICAgICAgICAgIC5hdHRyKCdmaWxsJywgJ3JlZCcpCiAgICAgICAgICAudHJhbnNpdGlvbigpCiAgICAgICAgICAuZHVyYXRpb24oMjAwMCkKICAgICAgICAgIC5hdHRyKCdyJywgMCk7CiAgICB9CgogICAgLy8gVXBkYXRlIHRoZSB0aXRsZSBmb3IgYWxsIG5vZGVzLgogICAgbm9kZS5zZWxlY3RBbGwoJ3RpdGxlJykudGV4dChkID0+IGQudGl0bGUpOwogICAgLy8gVXBkYXRlIHRoZSBmYXZpY29uIGZvciBhbGwgbm9kZXMuCiAgICBub2RlLnNlbGVjdEFsbCgnaW1hZ2UnKS5hdHRyKCdocmVmJywgZCA9PiBkLmljb25VcmwpOwoKICAgIC8vIFVwZGF0ZSBhbmQgcmVzdGFydCB0aGUgc2ltdWxhdGlvbiBpZiB0aGUgZ3JhcGggY2hhbmdlZC4KICAgIGlmICghbm9kZS5lbnRlcigpLmVtcHR5KCkgfHwgIW5vZGUuZXhpdCgpLmVtcHR5KCkgfHwKICAgICAgICAhbGluay5lbnRlcigpLmVtcHR5KCkgfHwgIWxpbmsuZXhpdCgpLmVtcHR5KCkgfHwKICAgICAgICAhZGFzaGVkTGluay5lbnRlcigpLmVtcHR5KCkgfHwgIWRhc2hlZExpbmsuZXhpdCgpLmVtcHR5KCkpIHsKICAgICAgdGhpcy5zaW11bGF0aW9uXy5ub2Rlcyhub2Rlcyk7CiAgICAgIGNvbnN0IGxpbmtzID0gdGhpcy5saW5rc18uY29uY2F0KHRoaXMuZGFzaGVkTGlua3NfKTsKICAgICAgdGhpcy5zaW11bGF0aW9uXy5mb3JjZSgnbGluaycpLmxpbmtzKGxpbmtzKTsKCiAgICAgIHRoaXMucmVzdGFydFNpbXVsYXRpb25fKCk7CiAgICB9CiAgfQoKICAvKiogQHByaXZhdGUgKi8KICBvblRpY2tfKCkgewogICAgY29uc3Qgbm9kZXMgPSB0aGlzLm5vZGVHcm91cF8uc2VsZWN0QWxsKCdnJyk7CiAgICBub2Rlcy5hdHRyKCd0cmFuc2Zvcm0nLCBkID0+IGB0cmFuc2xhdGUoJHtkLnh9LCR7ZC55fSlgKTsKCiAgICBjb25zdCBsaW5lcyA9IHRoaXMubGlua0dyb3VwXy5zZWxlY3RBbGwoJ2xpbmUnKTsKICAgIGxpbmVzLmF0dHIoJ3gxJywgZCA9PiBkLnNvdXJjZS54KQogICAgICAgIC5hdHRyKCd5MScsIGQgPT4gZC5zb3VyY2UueSkKICAgICAgICAuYXR0cigneDInLCBkID0+IGQudGFyZ2V0LngpCiAgICAgICAgLmF0dHIoJ3kyJywgZCA9PiBkLnRhcmdldC55KTsKCiAgICBjb25zdCBkYXNoZWRMaW5lcyA9IHRoaXMuZGFzaGVkTGlua0dyb3VwXy5zZWxlY3RBbGwoJ2xpbmUnKTsKICAgIGRhc2hlZExpbmVzLmF0dHIoJ3gxJywgZCA9PiBkLnNvdXJjZS54KQogICAgICAgIC5hdHRyKCd5MScsIGQgPT4gZC5zb3VyY2UueSkKICAgICAgICAuYXR0cigneDInLCBkID0+IGQudGFyZ2V0LngpCiAgICAgICAgLmF0dHIoJ3kyJywgZCA9PiBkLnRhcmdldC55KTsKCiAgICB0aGlzLnVwZGF0ZVRvb2xUaXBMaW5rcygpOwogIH0KCiAgLyoqCiAgICogQWRkcyBhIG5ldyBub2RlIHRvIHRoZSBncmFwaCwgcG9wdWxhdGVzIGl0cyBsaW5rcyBhbmQgZ2l2ZXMgaXQgYW4gaW5pdGlhbAogICAqIHBvc2l0aW9uLgogICAqCiAgICogQHBhcmFtIHshR3JhcGhOb2RlfSBub2RlCiAgICogQHByaXZhdGUKICAgKi8KICBhZGROb2RlXyhub2RlKSB7CiAgICB0aGlzLm5vZGVzXy5zZXQobm9kZS5pZCwgbm9kZSk7CiAgICB0aGlzLmFkZE5vZGVMaW5rc18obm9kZSk7CiAgICB0aGlzLmFkZERhc2hlZE5vZGVMaW5rc18obm9kZSk7CiAgICBub2RlLnNldEluaXRpYWxQb3NpdGlvbih0aGlzLndpZHRoXywgdGhpcy5oZWlnaHRfKTsKICB9CgogIC8qKgogICAqIEFkZHMgYWxsIHRoZSBsaW5rcyBmb3IgYSBub2RlIHRvIHRoZSBncmFwaC4KICAgKgogICAqIEBwYXJhbSB7IUdyYXBoTm9kZX0gbm9kZQogICAqIEBwcml2YXRlCiAgICovCiAgYWRkTm9kZUxpbmtzXyhub2RlKSB7CiAgICBmb3IgKGNvbnN0IGxpbmtUYXJnZXQgb2Ygbm9kZS5saW5rVGFyZ2V0cykgewogICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLm5vZGVzXy5nZXQobGlua1RhcmdldCk7CiAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICB0aGlzLmxpbmtzXy5wdXNoKHtzb3VyY2U6IG5vZGUsIHRhcmdldDogdGFyZ2V0fSk7CiAgICAgIH0KICAgIH0KICB9CgogIC8qKgogICAqIEFkZHMgYWxsIHRoZSBkYXNoZWQgbGlua3MgZm9yIGEgbm9kZSB0byB0aGUgZ3JhcGguCiAgICoKICAgKiBAcGFyYW0geyFHcmFwaE5vZGV9IG5vZGUKICAgKiBAcHJpdmF0ZQogICAqLwogIGFkZERhc2hlZE5vZGVMaW5rc18obm9kZSkgewogICAgZm9yIChjb25zdCBkYXNoZWRMaW5rVGFyZ2V0IG9mIG5vZGUuZGFzaGVkTGlua1RhcmdldHMpIHsKICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5ub2Rlc18uZ2V0KGRhc2hlZExpbmtUYXJnZXQpOwogICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgdGhpcy5kYXNoZWRMaW5rc18ucHVzaCh7c291cmNlOiBub2RlLCB0YXJnZXQ6IHRhcmdldH0pOwogICAgICB9CiAgICB9CiAgfQoKICAvKioKICAgKiBAcGFyYW0geyFHcmFwaE5vZGV9IGQgVGhlIGRyYWdnZWQgbm9kZS4KICAgKiBAcHJpdmF0ZQogICAqLwogIG9uRHJhZ1N0YXJ0XyhkKSB7CiAgICBpZiAoIWQzLmV2ZW50LmFjdGl2ZSkgewogICAgICB0aGlzLnJlc3RhcnRTaW11bGF0aW9uXygpOwogICAgfQogICAgZC5meCA9IGQueDsKICAgIGQuZnkgPSBkLnk7CiAgfQoKICAvKioKICAgKiBAcGFyYW0geyFHcmFwaE5vZGV9IGQgVGhlIGRyYWdnZWQgbm9kZS4KICAgKiBAcHJpdmF0ZQogICAqLwogIG9uRHJhZ18oZCkgewogICAgZC5meCA9IGQzLmV2ZW50Lng7CiAgICBkLmZ5ID0gZDMuZXZlbnQueTsKICB9CgogIC8qKgogICAqIEBwYXJhbSB7IUdyYXBoTm9kZX0gZCBUaGUgZHJhZ2dlZCBub2RlLgogICAqIEBwcml2YXRlCiAgICovCiAgb25EcmFnRW5kXyhkKSB7CiAgICBpZiAoIWQzLmV2ZW50LmFjdGl2ZSkgewogICAgICB0aGlzLnNpbXVsYXRpb25fLmFscGhhVGFyZ2V0KDApOwogICAgfQogICAgLy8gTGVhdmUgdGhlIG5vZGUgcGlubmVkIHdoZXJlIGl0IHdhcyBkcm9wcGVkLiBSZXR1cm4gaXQgdG8gZnJlZQogICAgLy8gcG9zaXRpb25pbmcgaWYgaXQncyBkcm9wcGVkIG91dHNpZGUgaXRzIGRlc2lnbmF0ZWQgYXJlYS4KICAgIGNvbnN0IGJvdW5kcyA9IGQuYWxsb3dlZFlSYW5nZSh0aGlzLmhlaWdodF8pOwogICAgaWYgKGQzLmV2ZW50LnkgPCBib3VuZHNbMF0gfHwgZDMuZXZlbnQueSA+IGJvdW5kc1sxXSkgewogICAgICBkLmZ4ID0gbnVsbDsKICAgICAgZC5meSA9IG51bGw7CiAgICB9CgogICAgLy8gVG9nZ2xlIHRoZSBwaW5uZWQgY2xhc3MgYXMgYXBwcm9wcmlhdGUgZm9yIHRoZSBjaXJjbGUgYmFja2luZyB0aGlzIG5vZGUuCiAgICBkMy5zZWxlY3QoYCNjaXJjbGUtJHtkLmlkfWApLmNsYXNzZWQoJ3Bpbm5lZCcsIGQuZnggIT0gbnVsbCk7CiAgfQoKICAvKioKICAgKiBAcGFyYW0geyFkMy5Gb3JjZU5vZGV9IGQgVGhlIG5vZGUgdG8gcG9zaXRpb24uCiAgICogQHByaXZhdGUKICAgKi8KICBnZXRUYXJnZXRZUG9zaXRpb25fKGQpIHsKICAgIHJldHVybiBkLnRhcmdldFlQb3NpdGlvbih0aGlzLmhlaWdodF8pOwogIH0KCiAgLyoqCiAgICogQHBhcmFtIHshZDMuRm9yY2VOb2RlfSBkIFRoZSBub2RlIHRvIHBvc2l0aW9uLgogICAqIEBwcml2YXRlCiAgICovCiAgZ2V0VGFyZ2V0WVBvc2l0aW9uU3RyZW5ndGhfKGQpIHsKICAgIHJldHVybiBkLnRhcmdldFlQb3NpdGlvblN0cmVuZ3RoOwogIH0KCiAgLyoqCiAgICogQHBhcmFtIHshZDMuRm9yY2VOb2RlfSBkIFRoZSBub2RlIHRvIHBvc2l0aW9uLgogICAqIEBwcml2YXRlCiAgICovCiAgZ2V0TWFueUJvZHlTdHJlbmd0aF8oZCkgewogICAgcmV0dXJuIGQubWFueUJvZHlTdHJlbmd0aDsKICB9CgogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBncmFwaFdpZHRoIFdpZHRoIG9mIHRoZSBncmFwaCB2aWV3IChzdmcpLgogICAqIEBwYXJhbSB7bnVtYmVyfSBncmFwaEhlaWdodCBIZWlnaHQgb2YgdGhlIGdyYXBoIHZpZXcgKHN2ZykuCiAgICogQHByaXZhdGUKICAgKi8KICB1cGRhdGVTZXBhcmF0b3JzXyhncmFwaFdpZHRoLCBncmFwaEhlaWdodCkgewogICAgY29uc3Qgc2VwYXJhdG9ycyA9IFsKICAgICAgWydQYWdlcycsICdGcmFtZSBUcmVlJywga1BhZ2VOb2Rlc1lSYW5nZV0sCiAgICAgIFsnJywgJ1dvcmtlcnMnLCBncmFwaEhlaWdodCAtIGtXb3JrZXJOb2Rlc1lSYW5nZV0sCiAgICAgIFsnJywgJ1Byb2Nlc3NlcycsIGdyYXBoSGVpZ2h0IC0ga1Byb2Nlc3NOb2Rlc1lSYW5nZV0sCiAgICBdOwogICAgY29uc3Qga0Fib3ZlTGFiZWxPZmZzZXQgPSAtNjsKICAgIGNvbnN0IGtCZWxvd0xhYmVsT2Zmc2V0ID0gMTQ7CgogICAgY29uc3QgZ3JvdXBzID0gdGhpcy5zZXBhcmF0b3JHcm91cF8uc2VsZWN0QWxsKCdnJykuZGF0YShzZXBhcmF0b3JzKTsKICAgIGlmIChncm91cHMuZW50ZXIoKSkgewogICAgICBjb25zdCBncm91cCA9IGdyb3Vwcy5lbnRlcigpLmFwcGVuZCgnZycpLmF0dHIoCiAgICAgICAgICAndHJhbnNmb3JtJywgZCA9PiBgdHJhbnNsYXRlKDAsJHtkWzJdfSlgKTsKICAgICAgZ3JvdXAuYXBwZW5kKCdsaW5lJykKICAgICAgICAgIC5hdHRyKCd4MScsIDEwKQogICAgICAgICAgLmF0dHIoJ3kxJywgMCkKICAgICAgICAgIC5hdHRyKCd4MicsIGdyYXBoV2lkdGggLSAxMCkKICAgICAgICAgIC5hdHRyKCd5MicsIDApCiAgICAgICAgICAuYXR0cignc3Ryb2tlJywgJ2JsYWNrJykKICAgICAgICAgIC5hdHRyKCdzdHJva2UtZGFzaGFycmF5JywgJzQnKTsKCiAgICAgIGdyb3VwLmVhY2goZnVuY3Rpb24oZCkgewogICAgICAgIGNvbnN0IHBhcmVudEdyb3VwID0gZDMuc2VsZWN0KHRoaXMpOwogICAgICAgIGlmIChkWzBdKSB7CiAgICAgICAgICBwYXJlbnRHcm91cC5hcHBlbmQoJ3RleHQnKQogICAgICAgICAgICAgIC5hdHRyKCd4JywgMjApCiAgICAgICAgICAgICAgLmF0dHIoJ3knLCBrQWJvdmVMYWJlbE9mZnNldCkKICAgICAgICAgICAgICAuYXR0cignY2xhc3MnLCAnc2VwYXJhdG9yJykKICAgICAgICAgICAgICAudGV4dChkID0+IGRbMF0pOwogICAgICAgIH0KICAgICAgICBpZiAoZFsxXSkgewogICAgICAgICAgcGFyZW50R3JvdXAuYXBwZW5kKCd0ZXh0JykKICAgICAgICAgICAgICAuYXR0cigneCcsIDIwKQogICAgICAgICAgICAgIC5hdHRyKCd5Jywga0JlbG93TGFiZWxPZmZzZXQpCiAgICAgICAgICAgICAgLmF0dHIoJ2NsYXNzJywgJ3NlcGFyYXRvcicpCiAgICAgICAgICAgICAgLnRleHQoZCA9PiBkWzFdKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIGdyb3Vwcy5hdHRyKCd0cmFuc2Zvcm0nLCBkID0+IGB0cmFuc2xhdGUoMCwke2RbMl19KWApOwogICAgZ3JvdXBzLnNlbGVjdEFsbCgnbGluZScpLmF0dHIoJ3gyJywgZ3JhcGhXaWR0aCAtIDEwKTsKICB9CgogIC8qKiBAcHJpdmF0ZSAqLwogIHJlc3RhcnRTaW11bGF0aW9uXygpIHsKICAgIC8vIFJlc3RhcnQgdGhlIHNpbXVsYXRpb24uCiAgICB0aGlzLnNpbXVsYXRpb25fLmFscGhhVGFyZ2V0KDAuMykucmVzdGFydCgpOwogIH0KCiAgLyoqCiAgICogUmVzaXplcyBhbmQgcmVzdGFydHMgdGhlIGFuaW1hdGlvbiBhZnRlciBhIHNpemUgY2hhbmdlLgogICAqIEBwcml2YXRlCiAgICovCiAgb25SZXNpemVfKCkgewogICAgdGhpcy53aWR0aF8gPSB0aGlzLnN2Z18uY2xpZW50V2lkdGg7CiAgICB0aGlzLmhlaWdodF8gPSB0aGlzLnN2Z18uY2xpZW50SGVpZ2h0OwoKICAgIHRoaXMudXBkYXRlU2VwYXJhdG9yc18odGhpcy53aWR0aF8sIHRoaXMuaGVpZ2h0Xyk7CgogICAgLy8gUmVzZXQgYm90aCBYIGFuZCBZIGF0dHJhY3RpdmUgZm9yY2VzLCBhcyB0aGV5J3JlIGNhY2hlZC4KICAgIGNvbnN0IHhGb3JjZSA9IGQzLmZvcmNlWCgpLngodGhpcy53aWR0aF8gLyAyKS5zdHJlbmd0aCgwLjEpOwogICAgY29uc3QgeUZvcmNlID0gZDMuZm9yY2VZKCkKICAgICAgICAgICAgICAgICAgICAgICAueSh0aGlzLmdldFRhcmdldFlQb3NpdGlvbl8uYmluZCh0aGlzKSkKICAgICAgICAgICAgICAgICAgICAgICAuc3RyZW5ndGgodGhpcy5nZXRUYXJnZXRZUG9zaXRpb25TdHJlbmd0aF8uYmluZCh0aGlzKSk7CiAgICB0aGlzLnNpbXVsYXRpb25fLmZvcmNlKCd4X3BvcycsIHhGb3JjZSk7CiAgICB0aGlzLnNpbXVsYXRpb25fLmZvcmNlKCd5X3BvcycsIHlGb3JjZSk7CiAgICB0aGlzLnNpbXVsYXRpb25fLmZvcmNlKCd5X2JvdW5kJywgYm91bmRpbmdGb3JjZSh0aGlzLmhlaWdodF8sIHRoaXMud2lkdGhfKSk7CgogICAgaWYgKCF0aGlzLndhc1Jlc2l6ZWRfKSB7CiAgICAgIHRoaXMud2FzUmVzaXplZF8gPSB0cnVlOwoKICAgICAgLy8gUmVpbml0aWFsaXplIGFsbCBub2RlIHBvc2l0aW9ucyBvbiBmaXJzdCByZXNpemUuCiAgICAgIHRoaXMubm9kZXNfLmZvckVhY2goCiAgICAgICAgICBub2RlID0+IG5vZGUuc2V0SW5pdGlhbFBvc2l0aW9uKHRoaXMud2lkdGhfLCB0aGlzLmhlaWdodF8pKTsKCiAgICAgIC8vIEFsbG93IHRoZSBzaW11bGF0aW9uIHRvIHNldHRsZSBieSBydW5uaW5nIGl0IGZvciBhIGJpdC4KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyMDA7ICsraSkgewogICAgICAgIHRoaXMuc2ltdWxhdGlvbl8udGljaygpOwogICAgICB9CiAgICB9CgogICAgdGhpcy5yZXN0YXJ0U2ltdWxhdGlvbl8oKTsKICB9Cn0KLyogQHR5cGUgez9HcmFwaH0gKi8KbGV0IGdyYXBoID0gbnVsbDsKZnVuY3Rpb24gb25Mb2FkKCkgewogIGdyYXBoID0KICAgICAgbmV3IEdyYXBoKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ3N2ZycpLCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdkaXYnKSk7CgogIGdyYXBoLmluaXRpYWxpemUoKTsKfQoKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBvbkxvYWQpOwoKICA8L3NjcmlwdD4KICA8L2hlYWQ+CiAgPGJvZHk+CiAgICA8ZGl2IGlkPSJ0b29sVGlwcyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSI+PC9kaXY+CiAgICA8c3ZnIGlkPSJncmFwaEJvZHkiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiPgogICAgICA8ZGVmcz4KICAgICAgICA8bWFya2VyIGlkPSJhcnJvd1RvU291cmNlIiB2aWV3Qm94PSIwIC01IDEwIDEwIiByZWZYPSItMTIiIHJlZlk9IjAiCiAgICAgICAgICAgICAgICBtYXJrZXJXaWR0aD0iOSIgbWFya2VySGVpZ2h0PSI2IiBvcmllbnQ9ImF1dG8iPgogICAgICAgICAgPHBhdGggZD0iTTE1LC03IEwwLDAgTDE1LDciIC8+CiAgICAgICAgPC9tYXJrZXI+CiAgICAgIDwvZGVmcz4KICAgIDwvc3ZnPgogIDwvYm9keT4KPC9odG1sPgo=" on-contentload="onWebViewReady_"
        allowscaling>
    </webview>
<!--_html_template_end_-->`,

  /**
   * The Mojo graph data source.
   *
   * @private {discards.mojom.GraphDumpRemote}
   */
  graphDump_: null,

  /**
   * The graph change listener.
   *
   * @private {discards.mojom.GraphChangeStreamInterface}
   */
  changeListener_: null,

  /**
   * The WebView's content window object.
   * @private {?Window}
   */
  contentWindow_: null,

  /** @override */
  ready() {
    this.graphDump_ = discards.mojom.GraphDump.getRemote();
  },

  /** @override */
  detached() {
    // TODO(siggi): Is there a way to tear down the binding explicitly?
    this.graphDump_ = null;
    this.changeListener_ = null;
  },

  /**
   * @param {!Event} event A request from the WebView.
   * @private
   */
  onMessage_(event) {
    const type = /** @type {string} */ (event.data[0]);
    const data = /** @type {Object|number} */ (event.data[1]);
    switch (type) {
      case 'requestNodeDescriptions':
        // Forward the request through the mojoms and bounce the reply back.
        this.graphDump_
            .requestNodeDescriptions(/** @type {!Array<number>} */ (data))
            .then(
                (descriptions) => this.contentWindow_.postMessage(
                    ['nodeDescriptions', descriptions.nodeDescriptionsJson],
                    '*'));
        break;
    }
  },

  /** @private */
  onWebViewReady_() {
    this.contentWindow_ = this.$.webView.contentWindow;
    this.changeListener_ =
        new DiscardsGraphChangeStreamImpl(this.contentWindow_);
    this.client_ =
        new discards.mojom.GraphChangeStreamReceiver(this.changeListener_);
    // Subscribe for graph updates.
    this.graphDump_.subscribeToChanges(
        this.client_.$.bindNewPipeAndPassRemote());

    window.addEventListener('message', this.onMessage_.bind(this));
  },
});
